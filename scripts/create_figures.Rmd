---
title: "Create Figures"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Description

Create figures for the manuscript, extended abstract and poster.

```{r}
library(data.table)
library(dplyr)
library(igraph)
library(ggplot2)
require(ggrepel)
library(grid)
library(gridExtra)
library(gtable)
require(magrittr)
library(patchwork)
library(tidyr)
set.seed(1510)
options(bitmapType='cairo')
`%ni%` <- Negate(`%in%`)
```

### Load data

Un-normalized data:

```{r}
input_dir = '/home/j.aguirreplans/Projects/Scipher/SampleSize/scripts/SampleSizeShiny/data'
plots_dir = '/home/j.aguirreplans/Projects/Scipher/SampleSize/data/out/plots'
numbers_file = paste(input_dir, 'dataset_numbers_complete_graph.txt', sep='/')
numbers_df = fread(numbers_file)
numbers_df$dataset = tolower(numbers_df$dataset)
sd_genes_file = paste(input_dir, "variation_by_gene.txt", sep="/")
sd_genes_df = fread(sd_genes_file)

input_dir = '/home/j.aguirreplans/Projects/Scipher/SampleSize/scripts/SampleSizeShiny/data/example_pearson_pval_0.05'
topology_results_file = paste(input_dir, 'topology_results_pearson_pval_0.05.txt', sep='/')
results_selected_df = fread(topology_results_file)
topology_results_by_size_file = paste(input_dir, 'topology_results_mean_pearson_pval_0.05.txt', sep='/')
topology_results_selected_by_size_df = fread(topology_results_by_size_file)
predictions_file = paste(input_dir, 'predictions_pearson_pval_0.05.txt', sep='/')
predicted_results_df = fread(predictions_file)
analytical_results_file = paste(input_dir, 'analytical_model_results_pearson_pval_0.05.txt', sep='/')
topology_results_selected_analytical_df = fread(analytical_results_file)
analytical_summary_file = paste(input_dir, 'analytical_model_summary_pearson_pval_0.05.txt', sep='/')
analytical_model_summary_df = fread(analytical_summary_file)
analytical_regression_results_file = paste(input_dir, 'analytical_model_regression_results_pearson_pval_0.05.txt', sep='/')
stretched_exponential_regression_df = fread(analytical_regression_results_file)
theoretical_sample_size_file = paste(input_dir, 'theoretical_sample_size_for_correlations_of_datasets.txt', sep='/')
sample_size_correlation_df = fread(theoretical_sample_size_file)
```

Normalized data:

```{r}
topology_type_normalization = "divide.L"
input_dir = '/home/j.aguirreplans/Projects/Scipher/SampleSize/scripts/SampleSizeShiny/data/example_pearson_pval_0.05'
topology_results_file = paste(input_dir, '/', 'topology_results_norm_', topology_type_normalization, '_pearson_pval_0.05.txt', sep='')
results_selected_norm_df = fread(topology_results_file)
topology_results_by_size_file = paste(input_dir, '/', 'topology_results_mean_norm_', topology_type_normalization, '_pearson_pval_0.05.txt', sep='')
topology_results_selected_by_size_norm_df = fread(topology_results_by_size_file)
predictions_file = paste(input_dir, '/', 'predictions_', topology_type_normalization, '_pearson_pval_0.05.txt', sep='')
predicted_results_norm_df = fread(predictions_file)
analytical_results_file = paste(input_dir, '/', 'analytical_model_results_', topology_type_normalization, '_pearson_pval_0.05.txt', sep='')
topology_results_selected_analytical_norm_df = fread(analytical_results_file)
```

Number of networks and maximum sample size:

```{r}
nrow((results_selected_df %>% dplyr::select(method, type_dataset, size, rep) %>% unique()))
max(((results_selected_df %>% dplyr::select(method, type_dataset, size, rep) %>% unique()))$size)
```

Number of networks and maximum sample size without counting TCGA full dataset:

```{r}
nrow((results_selected_df %>% dplyr::select(method, type_dataset, size, rep) %>% filter(!(type_dataset == "tcga:tcga")) %>% unique()))
max(((results_selected_df %>% dplyr::select(method, type_dataset, size, rep) %>% filter(!(type_dataset == "tcga:tcga")) %>% unique()))$size)
```

### Make plots

#### Curve plot

```{r}
#datasets_selected = c("gtex:whole.blood", "gtex:artery.tibial", "tcga:tcga-coad", "tcga:tcga-brca")
#datasets_selected = c("gtex:whole.blood", "gtex:artery.tibial", "tcga:tcga-coad", "tcga:tcga-brca", "scipher:scipher.complete.dataset")
#datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")
datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "gtex:whole.blood", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")
curve_plot = results_selected_norm_df %>%
  filter(type_dataset %in% datasets_selected) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:whole.blood", "GTEx: Whole blood")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:thyroid", "GTEx: Thyroid")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:breast.mammary.tissue", "GTEx: Breast")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-thca", "TCGA: Thyroid cancer")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-brca", "TCGA: Breast cancer")) %>%
  ggplot(aes(x=size, y=unnorm, col=type_dataset)) +
  geom_point(alpha=0.5, size=3) +
  #scale_x_continuous(trans = scales::log10_trans()) +
  #scale_color_manual(values = c("#D55E00", "#E69F00", "#44AA99", "#0072B2", "#56B4E9")) +
  #scale_color_manual(values = c("#D55E00", "#E69F00", "#44AA99", "#65F3BF", "#0072B2", "#56B4E9")) +
  scale_color_manual(values = c("#56B4E9", "#E69F00", "#44AA99", "#65F3BF", "#0072B2", "#D55E00")) +
  theme_linedraw() +
  xlab("Num. samples") +
  #xlab("log(N)") +
  ylab("Num. significant correlations") +
  guides(col=guide_legend(title="Dataset")) +
  theme(aspect.ratio=1, 
        plot.title =  element_text(size = 15, face="bold"), 
        axis.title = element_text(size = 14, face="bold"), 
        axis.text = element_text(size = 13), 
        legend.text = element_text(size = 13), 
        legend.title=element_text(size=14, face="bold"))
plot_file = paste(plots_dir, "curve_pearson_pval_0.05.png", sep="/")
print(curve_plot)
ggsave(
  plot_file,
  plot=curve_plot,
  dpi = 1200,
  #width = 10000,
  height = 5500,
  units = c("px")
)
```

#### Regression plot

```{r}
#datasets_selected = c("gtex:whole.blood", "gtex:artery.tibial", "tcga:tcga-coad", "tcga:tcga-brca")
#datasets_selected = c("gtex:whole.blood", "gtex:artery.tibial", "tcga:tcga-coad", "tcga:tcga-brca", "scipher:scipher.complete.dataset")
#datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")
datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "gtex:whole.blood", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")
#model_selected = "Stretched exponential (by optimization)"
model_selected = "Stretched exponential (by linear fit)"
regression_plot = stretched_exponential_regression_df %>% inner_join((topology_results_selected_analytical_df %>% dplyr::select(type_dataset, model, slope, intercept, a, b) %>% unique()), by=c("type_dataset", "model")) %>%
  filter((type_dataset %in% datasets_selected) & (model == model_selected)) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:whole.blood", "GTEx: Whole blood")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:thyroid", "GTEx: Thyroid")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:breast.mammary.tissue", "GTEx: Breast")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-thca", "TCGA: Thyroid cancer")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-brca", "TCGA: Breast cancer")) %>%
  ggplot(aes(x=x, y=y, col=type_dataset)) +
  geom_point(alpha=0.5, size=3) +
  geom_abline(aes(intercept=intercept, slope=slope, col=type_dataset), size=1) +
  theme_linedraw() +
  xlab("log(N)") +
  ylab("log[ log(L) - log(S) ]") +
  #scale_color_manual(values = c("#D55E00", "#E69F00", "#44AA99", "#0072B2", "#56B4E9")) +
  #scale_color_manual(values = c("#D55E00", "#E69F00", "#44AA99", "#65F3BF", "#0072B2", "#56B4E9")) +
  scale_color_manual(values = c("#56B4E9", "#E69F00", "#44AA99", "#65F3BF", "#0072B2", "#D55E00")) +
  guides(col=guide_legend(title="Dataset")) +
  theme(aspect.ratio=1, 
        plot.title =  element_text(size = 15, face="bold"), 
        axis.title = element_text(size = 14, face="bold"), 
        axis.text = element_text(size = 13), 
        legend.text = element_text(size = 13), 
        legend.title=element_text(size=14, face="bold"))
plot_file = paste(plots_dir, "regression_pearson_pval_0.05.png", sep="/")
print(regression_plot)
ggsave(
  plot_file,
  plot=regression_plot,
  dpi = 1200,
  #width = 9500,
  #height = 6000,
  units = c("px")
)
```

Create a table with the results for the figure:

```{r}
#datasets_selected = c("gtex:whole.blood", "gtex:artery.tibial", "tcga:tcga-coad", "tcga:tcga-brca")
#datasets_selected = c("gtex:whole.blood", "gtex:artery.tibial", "tcga:tcga-coad", "tcga:tcga-brca", "scipher:scipher.complete.dataset")
#datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")
datasets_selected = c("scipher:scipher.complete.dataset", "gtex:whole.blood", "gtex:thyroid", "tcga:tcga-thca", "gtex:breast.mammary.tissue", "tcga:tcga-brca")
#model_selected = "Stretched exponential (by optimization)"
model_selected = "Stretched exponential (by linear fit)"

# Show all information for model selected
analytical_model_summary_df$L_vs_total = abs((analytical_model_summary_df$unnorm_L - analytical_model_summary_df$total_num_edges)) / analytical_model_summary_df$total_num_edges
analytical_model_summary_df %>% 
  dplyr::select(type_dataset, model, a, b, L, L_vs_total, adj.r.squared, relative.error.mean) %>% 
  filter((type_dataset %in% datasets_selected) & (model == model_selected)) %>% unique() %>%
  arrange(factor(type_dataset, levels = datasets_selected, datasets_selected))

# Show all information for logarithmic
log_model_summary_df = analytical_model_summary_df %>% 
  dplyr::select(type_dataset, model, a, b, L, L_vs_total, adj.r.squared, relative.error.mean) %>% 
  filter((type_dataset %in% datasets_selected) & (model == "Logarithmic")) %>% unique() %>% 
  dplyr::select(type_dataset, adj.r.squared, relative.error.mean) %>% 
  rename("R**2" = "adj.r.squared", "epsilon" = "relative.error.mean") %>%
  arrange(factor(type_dataset, levels = datasets_selected)) %>%
  mutate_if(is.numeric, ~sprintf("%.2f",.))
print(log_model_summary_df)

# Create table for figure
power_law_summary_df = analytical_model_summary_df %>% 
  dplyr::select(type_dataset, model, a, adj.r.squared, relative.error.mean) %>% 
  filter((type_dataset %in% datasets_selected) & (model == model_selected)) %>%
  dplyr::select(-model) %>%
  arrange(factor(type_dataset, levels = datasets_selected)) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:whole.blood", "GTEx: Whole blood")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:thyroid", "GTEx: Thyroid")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:breast.mammary.tissue", "GTEx: Breast")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-thca", "TCGA: Thyroid cancer")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-brca", "TCGA: Breast cancer")) %>%
  rename("alpha"="a", "R**2" = "adj.r.squared", "epsilon" = "relative.error.mean") %>%
  unique() %>% 
  mutate_if(is.numeric, ~sprintf("%.2f",.))
print(power_law_summary_df)

# Bind power law with logarithm results
figure_summary_table = cbind(power_law_summary_df, (log_model_summary_df %>% select(-type_dataset)))

# Assign first row as row names
rownames(figure_summary_table) <- figure_summary_table$type_dataset
figure_summary_table$type_dataset <- NULL

# Customize and print table
colors_original_figure = c("#0072B2", "#65F3BF", "#44AA99", "#E69F00", "#D55E00", "#56B4E9")
colors_light_figure = c("#c3f7e4", "#9dfaea", "#fce8bb", "#ffd6b5", "#c0e5fa", "#2bb3ff")
core_figure = gridExtra::tableGrob(figure_summary_table, theme=ttheme_minimal(
  colhead=list(bg_params = list(fill = NA, col="black", lwd=1), 
               fg_params = list(parse=TRUE, fontface="bold")), 
  rowhead=list(bg_params = list(fill = NA, col=NA), 
               fg_params=list(col=colors_original_figure, fontface="plain")), 
  core=list(bg_params=list(fill=colors_light_figure, col="black", lwd=1))))
header <- gridExtra::tableGrob(figure_summary_table[1, 1:2], rows=NULL, cols=c("Power law", "Logarithm"), theme=ttheme_minimal(
  colhead=list(bg_params = list(fill = NA, col="black", lwd=1), 
               fg_params = list(parse=TRUE, fontface="plain"))))
figure_summary_table_plot <- gtable_combine(header[1,], core_figure, along=2)
figure_summary_table_plot$widths[2:length(figure_summary_table_plot$widths)] <- rep(max(figure_summary_table_plot$widths[2:length(figure_summary_table_plot$widths)]), length(figure_summary_table_plot$widths[2:length(figure_summary_table_plot$widths)])) # make column widths equal
#grid.newpage()
#grid.draw(figure_summary_table_plot) # see what it looks like before altering gtable
# change the relevant rows of gtable
grid.newpage()
#figure_summary_table_plot$layout[1:4 , c("l", "r")] <- list(c(2, 7), c(6, 8)) # For 8 columns (including b and L)
figure_summary_table_plot$layout[1:4 , c("l", "r")] <- list(c(2, 5), c(4, 6))
grid.draw(figure_summary_table_plot)

```

#### Prediction plot

```{r}
#datasets_selected = c("gtex:whole.blood", "gtex:artery.tibial", "tcga:tcga-coad", "tcga:tcga-brca")
#datasets_selected = c("gtex:whole.blood", "gtex:artery.tibial", "tcga:tcga-coad", "tcga:tcga-brca", "scipher:scipher.complete.dataset")
#datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")
datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "gtex:whole.blood", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")
#model_selected = "Stretched exponential (by optimization)"
model_selected = "Stretched exponential (by linear fit)"
prediction_plot = results_selected_norm_df %>% right_join((predicted_results_norm_df %>% dplyr::select(type_dataset, model, model_result, size) %>% mutate_at(c('model_result'), as.numeric) %>% unique()), by=c("type_dataset", "size")) %>%
  filter((type_dataset %in% datasets_selected) & (model == model_selected)) %>%
#results_selected_norm_df %>%
#  filter(type_dataset %in% datasets_selected) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:whole.blood", "GTEx: Whole blood")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:thyroid", "GTEx: Thyroid")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:breast.mammary.tissue", "GTEx: Breast")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-thca", "TCGA: Thyroid cancer")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-brca", "TCGA: Breast cancer")) %>%
  ggplot(aes(x=size, y=num_edges, col=type_dataset)) +
  geom_point(alpha=0.5, size=3) +
  #geom_line(data=(predicted_results_norm_df %>% filter((type_dataset %in% datasets_selected) & (model == model_selected)) %>% unique()), aes(x=size, y=model_result, col=type_dataset), size=1) +
  geom_line(aes(x=size, y=model_result, col=type_dataset), size=1) +
  scale_x_continuous(trans = scales::log10_trans()) +
  #scale_color_manual(values = c("#D55E00", "#E69F00", "#44AA99", "#0072B2", "#56B4E9")) +
  #scale_color_manual(values = c("#D55E00", "#E69F00", "#44AA99", "#65F3BF", "#0072B2", "#56B4E9")) +
  scale_color_manual(values = c("#56B4E9", "#E69F00", "#44AA99", "#65F3BF", "#0072B2", "#D55E00")) +
  theme_linedraw() +
  xlab("Num. samples (Log)") +
  ylab("Fraction of significant correlations") +
  guides(col=guide_legend(title="Dataset")) +
  theme(aspect.ratio=1, 
        plot.title =  element_text(size = 15, face="bold"), 
        axis.title = element_text(size = 14, face="bold"), 
        axis.text = element_text(size = 13), 
        legend.text = element_text(size = 13), 
        legend.title=element_text(size=14, face="bold"))
plot_file = paste(plots_dir, "prediction_pearson_pval_0.05.png", sep="/")
print(prediction_plot)
ggsave(
  plot_file,
  plot=prediction_plot,
  dpi = 1200,
  #width = 9500,
  #height = 6000,
  units = c("px")
)
```

Number of samples for a given % of significant edges:

```{r}
datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "gtex:whole.blood", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")
model_selected = "Stretched exponential (by linear fit)"
predicted_results_norm_df %>% dplyr::select(type_dataset, model, model_result, size) %>%
  mutate_at(c('model_result'), as.numeric) %>%
  filter((type_dataset %in% datasets_selected) & (model == model_selected)) %>%
  group_by(type_dataset) %>% 
  filter((abs(model_result - 0.25) == min(abs(model_result - 0.25))) | (abs(model_result - 0.5) == min(abs(model_result - 0.5))) | (abs(model_result - 0.75) == min(abs(model_result - 0.75))))
```


#### Comparison of models: stretched exponential vs. logarithm

Small example:

```{r}
input_dir = '/home/j.aguirreplans/Projects/Scipher/SampleSize/scripts/SampleSizeShiny/data/example_pearson_pval_0.05'
topology_results_small_example_file = paste(input_dir, 'topology_results_pearson_pval_0.05_small_example.txt', sep='/')
results_selected_small_example_df = fread(topology_results_small_example_file)
topology_results_by_size_small_example_file = paste(input_dir, 'topology_results_mean_pearson_pval_0.05_small_example.txt', sep='/')
topology_results_selected_by_size_small_example_df = fread(topology_results_by_size_small_example_file)
predictions_small_example_file = paste(input_dir, 'predictions_pearson_pval_0.05_small_example.txt', sep='/')
predicted_results_small_example_df = fread(predictions_small_example_file)
```

```{r}
models_selected = c("Stretched exponential (by linear fit)", "Logarithmic", "Square root", "Linear", "Exponential", "Mean")
dataset_selected = "gtex:whole.blood"
#dataset_selected = "tcga:tcga-brca"

# Join predicted results with mean
predicted_results_mean_small_example_df = rbind((topology_results_selected_by_size_small_example_df %>% dplyr::select(type_dataset, size, mean) %>% unique() %>% rename("model_result" = "mean") %>% mutate(model="Mean")), (predicted_results_small_example_df %>% dplyr::select(type_dataset, size, model_result, model) %>% unique() %>% mutate_at(c('model_result'), as.numeric))) %>% 
  filter(model %in% models_selected) %>%
  mutate(model = replace(model, model == "Stretched exponential (by linear fit)", "Power law")) %>%
  mutate(model = replace(model, model == "Linear", "Linear")) %>%
  mutate(model = replace(model, model == "Exponential", "Exponential")) %>%
  mutate(model = replace(model, model == "Square root", "Square root")) %>%
  mutate(model = replace(model, model == "Logarithmic", "Logarithm"))
predicted_results_mean_small_example_df$model <- factor(predicted_results_mean_small_example_df$model, levels = c("Mean", "Power law", "Logarithm", "Square root", "Linear", "Exponential"))

# Process and plot
comparison_plot_small_example = results_selected_small_example_df %>% 
  right_join(predicted_results_mean_small_example_df, by=c("type_dataset", "size")) %>%
  filter(type_dataset == dataset_selected) %>%
  filter(size <= max((results_selected_norm_df %>% filter(type_dataset == dataset_selected))$size)) %>%
  filter(size >= min((results_selected_small_example_df %>% filter(type_dataset == dataset_selected))$size)) %>%
  ggplot(aes(x=size, y=num_edges, col=model)) +
  geom_point(alpha=0.5, size=3, col="#91faad") +
  geom_line(aes(x=size, y=model_result, col=model), size=1) +
  scale_y_continuous(trans = scales::log10_trans()) +
  #scale_x_continuous(trans = scales::log10_trans()) +
  #scale_color_manual(values = c("#00f549", "#02b0f5", "#fc9403")) +
  theme_linedraw() +
  xlab("Num. samples") +
  ylab("Significant correlations (Log)") +
  #guides(col=guide_legend(title="Model")) +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 16, face="bold"), axis.text = element_text(size = 15), legend.text = element_text(size = 14), legend.title=element_blank(), legend.position="bottom")
plot_file = paste(plots_dir, "/comparison_models_small_size_pearson_pval_0.05_", dataset_selected, ".png", sep="")
print(comparison_plot_small_example)
ggsave(
  plot_file,
  plot=comparison_plot_small_example,
  dpi = 1200,
  width = 6600,
  height = 6700,
  units = c("px")
)
```

Large example:

```{r}
models_selected = c("Stretched exponential (by linear fit)", "Logarithmic", "Mean")
#dataset_selected = "gtex:whole.blood"
dataset_selected = "tcga:tcga-brca"

if(dataset_selected == "gtex:whole.blood"){
  palette =  c("#44AA99", "#e3f705", "#cc68f7")
} else {
  palette =  c("#0072B2", "#e3f705", "#cc68f7")
}

# Join predicted results with mean
predicted_results_norm_and_mean_df = rbind((topology_results_selected_by_size_norm_df %>% dplyr::select(type_dataset, size, mean_norm) %>% unique() %>% rename("model_result" = "mean_norm") %>% mutate(model="Mean")), (predicted_results_norm_df %>% dplyr::select(type_dataset, size, model_result, model) %>% unique() %>% mutate_at(c('model_result'), as.numeric))) %>% 
  filter(model %in% models_selected) %>%
  mutate(model = replace(model, model == "Stretched exponential (by linear fit)", "Power law")) %>%
  mutate(model = replace(model, model == "Logarithmic", "Logarithm"))
predicted_results_norm_and_mean_df$model <- factor(predicted_results_norm_and_mean_df$model, levels = c("Mean", "Power law", "Logarithm"))

# Process and plot
comparison_plot = results_selected_norm_df %>% 
  right_join(predicted_results_norm_and_mean_df, by=c("type_dataset", "size")) %>%
  filter(type_dataset == dataset_selected) %>%
  filter(size <= max((results_selected_norm_df %>% filter(type_dataset == dataset_selected))$size)) %>%
  filter(size >= min((results_selected_norm_df %>% filter(type_dataset == dataset_selected))$size)) %>%
  ggplot(aes(x=size, y=num_edges, col=model)) +
  geom_point(alpha=0.1, size=3, col=palette[1]) +
  geom_line(aes(x=size, y=model_result, col=model), size=1) +
  #scale_x_continuous(trans = scales::log10_trans()) +
  scale_color_manual(values = palette) +
  theme_linedraw() +
  xlab("Num. samples") +
  ylab("Fraction of significant correlations") +
  #guides(col=guide_legend(title="Model")) +
  theme(aspect.ratio=1, 
        plot.title =  element_text(size = 15, face="bold"), 
        axis.title = element_text(size = 14, face="bold"), 
        axis.text = element_text(size = 13), 
        legend.text = element_text(size = 13), 
        #legend.title=element_text(size=14, face="bold"), 
        legend.title=element_blank(), 
        legend.position="bottom")

plot_file = paste(plots_dir, "/comparison_models_pearson_pval_0.05_", dataset_selected, ".png", sep="")
print(comparison_plot)
ggsave(
  plot_file,
  plot=comparison_plot,
  dpi = 1200,
  #width = 6600,
  #height = 6700,
  units = c("px")
)

```

Create a panel with the results:

```{r}
# Use patchwork to concatenate plots
(((curve_plot +
      theme(legend.position="none")) | 
   (regression_plot +
      theme(legend.position="none"))) /
  ((comparison_plot +
      guides(col=guide_legend(title="Model", title.position="top", nrow=1,byrow=TRUE)) +
      theme(legend.position = 'bottom', legend.text = element_text(size = 11),  legend.title=element_text(size=13, face="bold"))) | 
    (prediction_plot +
      guides(col=guide_legend(title="Dataset", title.position="top", nrow=3,byrow=TRUE)) +
      theme(legend.position = 'bottom', legend.text = element_text(size = 11),  legend.title=element_text(size=13, face="bold")))) /
   figure_summary_table_plot) & 
  plot_annotation(tag_levels = 'A') & # Include letters 
  theme(plot.tag = element_text(face = 'bold')) # that are bold

plot_file = paste(plots_dir, "/modelling_results.png", sep="")
ggsave(
  plot_file,
  dpi = 1200,
  width = 10000,
  #height = 12500,
  height = 14500,
  units = c("px")
)
```

#### a vs. fraction of significant correlations plot

```{r}
#'  calculate_predictions_using_stretched_exponential_model_optimized
#'  Formula to calculate exponential decay of significant interactions from a list of sample sizes.
#'  This formula requires the use of the L parameter
#'  @param x List of sample sizes.
#'  @param a Slope coefficient.
#'  @param b Intercept coefficient.
#'  
calculate_predictions_using_stretched_exponential_model_optimized = function(x, L, a, b){
  y = L * exp((b*x**(-a+1))/(-a+1))
  #y = exp(log(L) - exp(b+a*log(x)))
  return(y)
}

#'  calculate_prediction_from_analytical_model
#'  Function to calculate predictions using a specific analytical model
#'  @param model Name of the model used.
#'  @param x_list List of values in the x axis (e.g. size)
#'  @param a Parameter a.
#'  @param b Parameter b.
#'  @param L Parameter L.
#'  
calculate_prediction_from_analytical_model = function(model, x_list, a, b, L){
  if(model == "Logarithmic"){
    prediction_result = (log(x_list)*a + b)
  } else if((model == "Stretched exponential (by optimization)") | (model == "Stretched exponential (by linear fit)")){
    prediction_result = calculate_predictions_using_stretched_exponential_model_optimized(x=x_list, L=L, a=a, b=b)
  } else if(model == "Stretched exponential (without L)"){
    prediction_result = calculate_predictions_using_stretched_exponential_model_without_L(x=x_list, a=a, b=b)
  }
  return(prediction_result)
}
```

```{r}
#datasets_selected = c("gtex:whole.blood", "gtex:artery.tibial", "tcga:tcga-coad", "tcga:tcga-brca")
#datasets_selected = c("gtex:whole.blood", "gtex:artery.tibial", "tcga:tcga-coad", "tcga:tcga-brca", "scipher:scipher.complete.dataset")
#datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")
datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "gtex:whole.blood", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")
#model_selected = "Stretched exponential (by optimization)"
model_selected = "Stretched exponential (by linear fit)"
sample_size_vs_a_df = analytical_model_summary_df %>% inner_join(sample_size_correlation_df, by=c("type_dataset"="dataset")) %>% 
  #filter((type_dataset %in% datasets_selected) & (model == model_selected)) 
  filter(model == model_selected)

# Calculate number of edges for each critical correlation using model
sample_size_vs_a_df$num_edges_from_statistical_corrected = calculate_prediction_from_analytical_model(model=model_selected, x_list=sample_size_vs_a_df$sample_size_statistical_corrected, a=sample_size_vs_a_df$a, b=sample_size_vs_a_df$b, L=sample_size_vs_a_df$L)
sample_size_vs_a_df$num_edges_from_statistical_corrected = sample_size_vs_a_df$num_edges_from_statistical_corrected * sample_size_vs_a_df$max_value_in_dataset
sample_size_vs_a_df$num_edges_from_statistical_corrected_norm = sample_size_vs_a_df$num_edges_from_statistical_corrected / sample_size_vs_a_df$total_num_edges
```

```{r}
type_correlation_selected = "weak"
sample_size_vs_a_df %>%
  filter(type_correlation == type_correlation_selected) %>%
  arrange(desc(a))

output_dir = '/home/j.aguirreplans/Projects/Scipher/SampleSize/data/out/tables'
output_file = paste(output_dir, 'a_vs_fraction_sig_correlations_pearson_pval_0.05.txt', sep='/')
sample_size_vs_a_df %>% arrange(desc(a)) %>% fwrite(output_file)
```

```{r}
type_correlation_selected = "weak"
#sample_size_vs_a_df$data_col = ifelse(sample_size_vs_a_df$type_dataset == "gtex:whole.blood", "#E69F00", ifelse(sample_size_vs_a_df$type_dataset == "gtex:artery.tibial", "#D55E00", ifelse(sample_size_vs_a_df$type_dataset == "tcga:tcga-coad", "#56B4E9", ifelse(sample_size_vs_a_df$type_dataset == "tcga:tcga-brca", "#0072B2", "black"))))

a_vs_fraction_sig_correlations_plot = sample_size_vs_a_df %>% 
  filter(type_correlation == type_correlation_selected) %>% 
  filter(!(type_dataset == "tcga:tcga")) %>% 
  mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:whole.blood", "GTEx: Whole blood")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:thyroid", "GTEx: Thyroid")) %>%
  #mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:artery.tibial", "GTEx: Artery tibial")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:breast.mammary.tissue", "GTEx: Breast")) %>%
  #mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-coad", "TCGA: Colon cancer")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-thca", "TCGA: Thyroid cancer")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-brca", "TCGA: Breast cancer")) %>%
  ggplot(aes(x=a, y=num_edges_from_statistical_corrected_norm)) + 
  geom_point() +
  #geom_point(data = . %>% filter(type_dataset == "TCGA: Colon cancer"), color = "#56B4E9") +
  #geom_point(data = . %>% filter(type_dataset == "TCGA: Thyroid cancer"), color = "#56B4E9") +
  geom_point(data = . %>% filter(type_dataset == "TCGA: Thyroid cancer"), color = "#D55E00") +
  geom_point(data = . %>% filter(type_dataset == "TCGA: Breast cancer"), color = "#0072B2") +
  geom_point(data = . %>% filter(type_dataset == "R. arthritis"), color = "#65F3BF") +
  geom_point(data = . %>% filter(type_dataset == "GTEx: Whole blood"), color = "#44AA99") +
  #geom_point(data = . %>% filter(type_dataset == "GTEx: Artery tibial"), color = "#D55E00") +
  geom_point(data = . %>% filter(type_dataset == "GTEx: Thyroid"), color = "#E69F00") +
  #geom_point(data = . %>% filter(type_dataset == "GTEx: Breast"), color = "#D55E00") +
  geom_point(data = . %>% filter(type_dataset == "GTEx: Breast"), color = "#56B4E9") +
  xlab(expression(alpha)) +
  ylab("Fraction of correlations above 0.2") +
  #guides(col=guide_legend(title="Dataset")) +
  theme_linedraw() +
  theme(aspect.ratio=1, plot.title =  element_text(size = 15, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 13), legend.text = element_text(size = 13), legend.title=element_text(size=14, face="bold")) +
  geom_text_repel(
    #data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "gtex:whole.blood"),
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected) %>% mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:thyroid", "GTEx: Thyroid"))), type_dataset == "GTEx: Thyroid"),
    aes(label = type_dataset), col = "#E69F00",
    size = 4,
    box.padding = unit(0.3, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    #data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "gtex:artery.tibial"),
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected) %>% mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:breast.mammary.tissue", "GTEx: Breast"))), type_dataset == "GTEx: Breast"),
    aes(label = type_dataset), col = "#56B4E9",
    size = 4,
    box.padding = unit(0.8, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected) %>% mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:whole.blood", "GTEx: Whole blood"))), type_dataset == "GTEx: Whole blood"),
    aes(label = type_dataset), col = "#44AA99",
    size = 4,
    box.padding = unit(0.8, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected) %>% mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis"))), type_dataset == "R. arthritis"),
    aes(label = type_dataset), col = "#65F3BF",
    size = 4,
    box.padding = unit(0.5, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected) %>% mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-brca", "TCGA: Breast cancer"))), type_dataset == "TCGA: Breast cancer"),
    aes(label = type_dataset), col = "#0072B2",
    size = 4,
    box.padding = unit(0.35, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    #data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "tcga:tcga-coad"),
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected) %>% mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-thca", "TCGA: Thyroid cancer"))), type_dataset == "TCGA: Thyroid cancer"),
    aes(label = type_dataset), col = "#D55E00",
    size = 4,
    box.padding = unit(0.5, "lines"),
    point.padding = unit(0.3, "lines")
  )

print(a_vs_fraction_sig_correlations_plot)
plot_file = paste(plots_dir, "a_vs_fraction_sig_correlations_pearson_pval_0.05.png", sep="/")
ggsave(
  plot_file,
  plot=a_vs_fraction_sig_correlations_plot,
  dpi = 1200,
  #width = 6400,
  #height = 6000,
  units = c("px")
)
```

```{r}
type_correlation_selected = "weak"
#sample_size_vs_a_df$data_col = ifelse(sample_size_vs_a_df$type_dataset == "gtex:whole.blood", "#E69F00", ifelse(sample_size_vs_a_df$type_dataset == "gtex:artery.tibial", "#D55E00", ifelse(sample_size_vs_a_df$type_dataset == "tcga:tcga-coad", "#56B4E9", ifelse(sample_size_vs_a_df$type_dataset == "tcga:tcga-brca", "#0072B2", "black"))))

a_vs_fraction_sig_correlations_empty_plot = sample_size_vs_a_df %>% 
  filter(type_correlation == type_correlation_selected) %>% 
  filter(!(type_dataset == "tcga:tcga")) %>% 
  mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:whole.blood", "GTEx: Whole blood")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:thyroid", "GTEx: Thyroid")) %>%
  #mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:artery.tibial", "GTEx: Artery tibial")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:breast.mammary.tissue", "GTEx: Breast")) %>%
  #mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-coad", "TCGA: Colon cancer")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-thca", "TCGA: Thyroid cancer")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-brca", "TCGA: Breast cancer")) %>%
  ggplot(aes(x=a, y=num_edges_from_statistical_corrected_norm)) + 
  geom_point() +
  #geom_point(data = . %>% filter(type_dataset == "TCGA: Colon cancer"), color = "#56B4E9") +
  #geom_point(data = . %>% filter(type_dataset == "TCGA: Thyroid cancer"), color = "#56B4E9") +
  geom_point(data = . %>% filter(type_dataset == "TCGA: Thyroid cancer"), color = "#D55E00") +
  geom_point(data = . %>% filter(type_dataset == "TCGA: Breast cancer"), color = "#0072B2") +
  geom_point(data = . %>% filter(type_dataset == "R. arthritis"), color = "#65F3BF") +
  geom_point(data = . %>% filter(type_dataset == "GTEx: Whole blood"), color = "#44AA99") +
  #geom_point(data = . %>% filter(type_dataset == "GTEx: Artery tibial"), color = "#D55E00") +
  geom_point(data = . %>% filter(type_dataset == "GTEx: Thyroid"), color = "#E69F00") +
  #geom_point(data = . %>% filter(type_dataset == "GTEx: Breast"), color = "#D55E00") +
  geom_point(data = . %>% filter(type_dataset == "GTEx: Breast"), color = "#56B4E9") +
  xlab(expression(alpha)) +
  ylab("Fraction of correlations above 0.2") +
  #guides(col=guide_legend(title="Dataset")) +
  theme_linedraw() +
  theme(aspect.ratio=1, plot.title =  element_text(size = 15, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 13), legend.text = element_text(size = 13), legend.title=element_text(size=14, face="bold"))

print(a_vs_fraction_sig_correlations_empty_plot)
plot_file = paste(plots_dir, "a_vs_fraction_sig_correlations_pearson_pval_0.05_no_labels.png", sep="/")
ggsave(
  plot_file,
  plot=a_vs_fraction_sig_correlations_empty_plot,
  dpi = 1200,
  width = 6000,
  #height = 6000,
  units = c("px")
)
```


#### Variation plot

Create plots showing the variation of each gene across samples:

```{r}
#datasets_selected = c("Artery.Tibial", "Whole.Blood", "TCGA-BRCA", "TCGA-COAD", "scipher.complete.dataset")
#datasets_selected = c("Breast.Mammary.Tissue", "Thyroid", "TCGA-BRCA", "TCGA-THCA", "scipher.complete.dataset")
datasets_selected = c("Breast.Mammary.Tissue", "Thyroid", "Whole.Blood", "TCGA-BRCA", "TCGA-THCA", "scipher.complete.dataset")
parameters = c("sd", "mean", "cv")
parameter2label <- list("sd"="SD", "mean"="mean", "cv"="CV")
distribution_plots = list()
for (x in 1:length(parameters)){
  parameter = parameters[x]
  distribution_plot = sd_genes_df %>%
    #filter(sd < 500000) %>%
    #filter(sd < 5000) %>%
    filter(type_dataset %in% datasets_selected) %>%
    mutate(type_dataset = replace(type_dataset, type_dataset == "scipher.complete.dataset", "R. arthritis")) %>%
    mutate(type_dataset = replace(type_dataset, type_dataset == "Thyroid", "GTEx: Thyroid")) %>%
    mutate(type_dataset = replace(type_dataset, type_dataset == "Breast.Mammary.Tissue", "GTEx: Breast")) %>%
    mutate(type_dataset = replace(type_dataset, type_dataset == "Whole.Blood", "GTEx: Whole blood")) %>%
    mutate(type_dataset = replace(type_dataset, type_dataset == "TCGA-THCA", "TCGA: Thyroid cancer")) %>%
    mutate(type_dataset = replace(type_dataset, type_dataset == "TCGA-BRCA", "TCGA: Breast cancer")) %>%
    ggplot(aes(.data[[parameter]], color=type_dataset)) +
    geom_freqpoly(size=1.5) +
    #geom_histogram(alpha=0.2) +
    #scale_color_manual(values = c("#D55E00", "#E69F00", "#44AA99", "#0072B2", "#56B4E9")) +
    scale_color_manual(values = c("#D55E00", "#E69F00", "#44AA99", "#65F3BF", "#0072B2", "#56B4E9")) +
    scale_x_log10() + 
    scale_y_log10() + 
    labs(x=paste("Gene expression ", parameter2label[[parameter]], " (Log)", sep=""), y = "Number of genes (Log)") +
    theme_linedraw() + 
    guides(col=guide_legend(title="Dataset")) +
    theme(aspect.ratio=1, plot.title =  element_text(size = 15, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 13), legend.text = element_text(size = 13), legend.title=element_text(size=14, face="bold"))
  
  # Save distribution plot without changes in the theme, because we will tune it afterwards with patchwork
  distribution_plots[[x]] = distribution_plot
  
  plot_file = paste(plots_dir, "/distribution_", parameter, "_genes.png", sep="")
  ggsave(
    plot_file,
    plot=distribution_plot,
    dpi = 1200,
    #width = 10000,
    #height = 6000,
    units = c("px")
  )
  print(distribution_plot)
}
```

```{r}
output_dir = '/home/j.aguirreplans/Projects/Scipher/SampleSize/data/out/tables'
a_vs_fraction_corr_file = paste(output_dir, 'a_vs_fraction_sig_correlations_pearson_pval_0.05.txt', sep='/')
a_vs_fraction_corr_df = fread(a_vs_fraction_corr_file) %>% rename("dataset_name"="type_dataset")
head(a_vs_fraction_corr_df)
```

```{r}
sd_cut=10
mean_cut=10
cv_cut=50
sd_genes_df %>% group_by(dataset, type_dataset) %>% summarize(mean_sd=mean(sd), median_sd=median(sd), mean_mean=mean(mean), median_mean=median(mean), mean_cv=mean(cv), median_cv=median(cv))
sd_genes_vs_a_df = sd_genes_df %>% group_by(dataset, type_dataset, dataset_name) %>% summarize(num_genes_above_sd_cut=length(sd[sd >= sd_cut]), num_genes_above_mean_cut=length(mean[mean >= mean_cut]), num_genes_above_cv_cut=length(cv[cv >= cv_cut]), num_genes=n()) %>% ungroup() %>% mutate(fraction_genes_above_sd_cut = num_genes_above_sd_cut / num_genes, fraction_genes_above_mean_cut = num_genes_above_mean_cut / num_genes, fraction_genes_above_cv_cut = num_genes_above_cv_cut / num_genes) %>% inner_join(a_vs_fraction_corr_df, by=c("dataset_name"="dataset_name")) %>% select(!c("type_correlation", "correlation", "sample_size_statistical", "sample_size_statistical_corrected", "num_edges_from_statistical_corrected", "num_edges_from_statistical_corrected_norm")) %>% unique()

head(sd_genes_vs_a_df)
```

```{r}
parameters = c("sd", "mean", "cv")
parameter2label <- list("sd"="SD", "mean"="mean", "cv"="CV")
scatter_plots = list()
for (x in 1:length(parameters)){
  parameter = parameters[x]
  if (parameter == "cv"){
    cut = cv_cut
  } else if (parameter == "sd"){
    cut = sd_cut
  } else if (parameter == "mean"){
    cut = mean_cut
  }
  param_vs_a_plot = sd_genes_vs_a_df %>%
    mutate(dataset_name = replace(dataset_name, dataset_name == "scipher:scipher.complete.dataset", "R. arthritis")) %>%
    mutate(dataset_name = replace(dataset_name, dataset_name == "gtex:thyroid", "GTEx: Thyroid")) %>%
    mutate(dataset_name = replace(dataset_name, dataset_name == "gtex:breast.mammary.tissue", "GTEx: Breast")) %>%
    mutate(dataset_name = replace(dataset_name, dataset_name == "gtex:whole.blood", "GTEx: Whole blood")) %>%
    mutate(dataset_name = replace(dataset_name, dataset_name == "tcga:tcga-thca", "TCGA: Thyroid cancer")) %>%
    mutate(dataset_name = replace(dataset_name, dataset_name == "tcga:tcga-brca", "TCGA: Breast cancer")) %>%
    ggplot(aes(x=a, y=.data[[paste("fraction_genes_above_", parameter, "_cut", sep="")]])) + 
    geom_point() +
    geom_point(data = . %>% filter(dataset_name == "TCGA: Thyroid cancer"), color = "#56B4E9") +
    geom_point(data = . %>% filter(dataset_name == "TCGA: Breast cancer"), color = "#0072B2") +
    geom_point(data = . %>% filter(dataset_name == "R. arthritis"), color = "#65F3BF") +
    geom_point(data = . %>% filter(dataset_name == "GTEx: Whole blood"), color = "#44AA99") +
    geom_point(data = . %>% filter(dataset_name == "GTEx: Thyroid"), color = "#E69F00") +
    geom_point(data = . %>% filter(dataset_name == "GTEx: Breast"), color = "#D55E00") +
    xlab(expression(alpha)) +
    ylab(paste("Fraction of genes with ", parameter2label[[parameter]], " above ", cut, sep="")) +
    theme_linedraw() +
    theme(aspect.ratio=1, plot.title =  element_text(size = 15, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 13), legend.text = element_text(size = 13), legend.title=element_text(size=14, face="bold")) +
    geom_text_repel(
      data = subset((sd_genes_vs_a_df %>% mutate(dataset_name = replace(dataset_name, dataset_name == "gtex:thyroid", "GTEx: Thyroid"))), dataset_name == "GTEx: Thyroid"),
      aes(label = dataset_name), col = "#E69F00",
      size = 4,
      box.padding = unit(0.5, "lines"),
      point.padding = unit(0.3, "lines")
    ) +
    geom_text_repel(
      data = subset((sd_genes_vs_a_df %>% mutate(dataset_name = replace(dataset_name, dataset_name == "gtex:breast.mammary.tissue", "GTEx: Breast"))), dataset_name == "GTEx: Breast"),
      aes(label = dataset_name), col = "#D55E00",
      size = 4,
      box.padding = unit(0.5, "lines"),
      point.padding = unit(0.3, "lines")
    ) +
    geom_text_repel(
      data = subset((sd_genes_vs_a_df %>% mutate(dataset_name = replace(dataset_name, dataset_name == "gtex:whole.blood", "GTEx: Whole blood"))), dataset_name == "GTEx: Whole blood"),
      aes(label = dataset_name), col = "#44AA99",
      size = 4,
      box.padding = unit(0.5, "lines"),
      point.padding = unit(0.3, "lines")
    ) +
    geom_text_repel(
      data = subset((sd_genes_vs_a_df %>% mutate(dataset_name = replace(dataset_name, dataset_name == "scipher:scipher.complete.dataset", "R. arthritis"))), dataset_name == "R. arthritis"),
      aes(label = dataset_name), col = "#65F3BF",
      size = 4,
      box.padding = unit(0.5, "lines"),
      point.padding = unit(0.3, "lines")
    ) +
    geom_text_repel(
      data = subset((sd_genes_vs_a_df %>% mutate(dataset_name = replace(dataset_name, dataset_name == "tcga:tcga-brca", "TCGA: Breast cancer"))), dataset_name == "TCGA: Breast cancer"),
      aes(label = dataset_name), col = "#0072B2",
      size = 4,
      box.padding = unit(0.5, "lines"),
      point.padding = unit(0.3, "lines")
    ) +
    geom_text_repel(
      data = subset((sd_genes_vs_a_df %>% mutate(dataset_name = replace(dataset_name, dataset_name == "tcga:tcga-thca", "TCGA: Thyroid cancer"))), dataset_name == "TCGA: Thyroid cancer"),
      aes(label = dataset_name), col = "#56B4E9",
      size = 4,
      box.padding = unit(0.5, "lines"),
      point.padding = unit(0.3, "lines")
    )
  plot_file = paste(plots_dir, "/a_vs_fraction_genes_above_", parameter, "_cut.png", sep="")
  ggsave(
    plot_file,
    dpi = 1200,
    width = 6000,
    #height = 6000,
    units = c("px")
  )
  print(param_vs_a_plot)
  scatter_plots[[x]] = param_vs_a_plot
}
```

Create a panel with the CV results:

```{r}
# Use patchwork to concatenate plots
# distribution_plots[[3]] / scatter_plots[[3]] + 
#   plot_layout(guides = 'collect') + # Center legend
#   plot_annotation(tag_levels = 'A') & # Include letters 
#     theme(plot.tag = element_text(face = 'bold')) # that are bold
a_vs_fraction_sig_correlations_plot / distribution_plots[[3]] / scatter_plots[[3]] + 
  plot_layout(guides = 'collect') + # Center legend
  plot_annotation(tag_levels = 'A') & # Include letters 
    theme(plot.tag = element_text(face = 'bold')) # that are bold

plot_file = paste(plots_dir, "/cv_results.png", sep="")
ggsave(
  plot_file,
  dpi = 1200,
  width = 8500,
  height = 15000,
  units = c("px")
)

```

Create a panel with all the results:

```{r}
# Use patchwork to concatenate plots
(((curve_plot +
      labs(tag = 'A') +
      theme(legend.position="none")) | 
    (comparison_plot +
      labs(tag = 'D') +
      guides(col=guide_legend(title="Model", title.position="top")) +
      theme(legend.position = c(0.7, 0.24), legend.text = element_text(size = 11), legend.title=element_text(size=13, face="bold"), legend.background = element_rect(size=0.2, linetype="solid", colour ="black"))) |
    (a_vs_fraction_sig_correlations_plot +
     labs(tag = 'F') +
     theme(legend.position="none"))) /
  ((regression_plot +
      labs(tag = 'B') +
      theme(legend.position="none")) | 
    (prediction_plot +
      labs(tag = 'E') +
      #guides(col=guide_legend(title="Dataset", title.position="top", nrow=3,byrow=TRUE)) +
      #theme(legend.position = 'bottom', legend.text = element_text(size = 11), legend.title=element_text(size=13, face="bold"))) |
      theme(legend.position = 'none')) |
     (distribution_plots[[3]] +
     labs(tag = 'G') +
     theme(legend.position="none"))) /
   ((wrap_elements(figure_summary_table_plot) + labs(tag='C')) | 
      (scatter_plots[[3]] + labs(tag='H')))) & 
  #plot_annotation(tag_levels = 'A') & # Include letters 
  theme(plot.tag = element_text(face = 'bold')) # that are bold

plot_file = paste(plots_dir, "/modelling_and_cv_results.png", sep="")
ggsave(
  plot_file,
  dpi = 1200,
  width = 15000,
  #height = 12500,
  height = 15000,
  units = c("px")
)
```


#### Other plots comparing a with other parameters

```{r}
type_correlation_selected = "weak"
#sample_size_vs_a_df$data_col = ifelse(sample_size_vs_a_df$type_dataset == "gtex:whole.blood", "#E69F00", ifelse(sample_size_vs_a_df$type_dataset == "gtex:artery.tibial", "#D55E00", ifelse(sample_size_vs_a_df$type_dataset == "tcga:tcga-coad", "#56B4E9", ifelse(sample_size_vs_a_df$type_dataset == "tcga:tcga-brca", "#0072B2", "black"))))

sample_size_vs_a_df %>% 
  filter(type_correlation == type_correlation_selected) %>% 
  filter(!(type_dataset == "tcga:tcga")) %>% 
  mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:whole.blood", "GTEx: Whole blood")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:artery.tibial", "GTEx: Artery tibial")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-coad", "TCGA: Colon cancer")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-brca", "TCGA: Breast cancer")) %>%
  ggplot(aes(x=unnorm_L, y=num_edges_from_statistical_corrected_norm)) + 
  geom_point() +
  geom_point(data = . %>% filter(type_dataset == "TCGA: Colon cancer"), color = "#56B4E9") +
  geom_point(data = . %>% filter(type_dataset == "TCGA: Breast cancer"), color = "#0072B2") +
  geom_point(data = . %>% filter(type_dataset == "R. arthritis"), color = "#44AA99") +
  geom_point(data = . %>% filter(type_dataset == "GTEx: Whole blood"), color = "#E69F00") +
  geom_point(data = . %>% filter(type_dataset == "GTEx: Artery tibial"), color = "#D55E00") +
  xlab("L") +
  ylab("Fraction of correlations above 0.2") +
  #guides(col=guide_legend(title="Dataset")) +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 16, face="bold"), axis.text = element_text(size = 15), legend.text = element_text(size = 14), legend.title=element_text(size=15, face="bold")) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "gtex:whole.blood"),
    aes(label = type_dataset), col = "#E69F00",
    size = 5,
    box.padding = unit(0.5, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "gtex:artery.tibial"),
    aes(label = type_dataset), col = "#D55E00",
    size = 5,
    box.padding = unit(0.35, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected) %>% mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis"))), type_dataset == "R. arthritis"),
    aes(label = type_dataset), col = "#44AA99",
    size = 5,
    box.padding = unit(0.5, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "tcga:tcga-brca"),
    aes(label = type_dataset), col = "#0072B2",
    size = 5,
    box.padding = unit(0.35, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "tcga:tcga-coad"),
    aes(label = type_dataset), col = "#56B4E9",
    size = 5,
    box.padding = unit(0.5, "lines"),
    point.padding = unit(0.3, "lines")
  )

plot_file = paste(plots_dir, "L_vs_fraction_sig_correlations_pearson_pval_0.05.png", sep="/")
ggsave(
  plot_file,
  dpi = 1200,
  width = 6400,
  height = 6000,
  units = c("px")
)
```

```{r}
type_correlation_selected = "weak"
#sample_size_vs_a_df$data_col = ifelse(sample_size_vs_a_df$type_dataset == "gtex:whole.blood", "#E69F00", ifelse(sample_size_vs_a_df$type_dataset == "gtex:artery.tibial", "#D55E00", ifelse(sample_size_vs_a_df$type_dataset == "tcga:tcga-coad", "#56B4E9", ifelse(sample_size_vs_a_df$type_dataset == "tcga:tcga-brca", "#0072B2", "black"))))

sample_size_vs_a_df %>% 
  filter(type_correlation == type_correlation_selected) %>% 
  filter(!(type_dataset == "tcga:tcga")) %>% 
  mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:whole.blood", "GTEx: Whole blood")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:artery.tibial", "GTEx: Artery tibial")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-coad", "TCGA: Colon cancer")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-brca", "TCGA: Breast cancer")) %>%
  ggplot(aes(x=b, y=num_edges_from_statistical_corrected_norm)) + 
  geom_point() +
  geom_point(data = . %>% filter(type_dataset == "TCGA: Colon cancer"), color = "#56B4E9") +
  geom_point(data = . %>% filter(type_dataset == "TCGA: Breast cancer"), color = "#0072B2") +
  geom_point(data = . %>% filter(type_dataset == "R. arthritis"), color = "#44AA99") +
  geom_point(data = . %>% filter(type_dataset == "GTEx: Whole blood"), color = "#E69F00") +
  geom_point(data = . %>% filter(type_dataset == "GTEx: Artery tibial"), color = "#D55E00") +
  xlab("b") +
  ylab("Fraction of correlations above 0.2") +
  #guides(col=guide_legend(title="Dataset")) +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 16, face="bold"), axis.text = element_text(size = 15), legend.text = element_text(size = 14), legend.title=element_text(size=15, face="bold")) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "gtex:whole.blood"),
    aes(label = type_dataset), col = "#E69F00",
    size = 5,
    box.padding = unit(0.5, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "gtex:artery.tibial"),
    aes(label = type_dataset), col = "#D55E00",
    size = 5,
    box.padding = unit(0.35, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected) %>% mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis"))), type_dataset == "R. arthritis"),
    aes(label = type_dataset), col = "#44AA99",
    size = 5,
    box.padding = unit(0.5, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "tcga:tcga-brca"),
    aes(label = type_dataset), col = "#0072B2",
    size = 5,
    box.padding = unit(0.35, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "tcga:tcga-coad"),
    aes(label = type_dataset), col = "#56B4E9",
    size = 5,
    box.padding = unit(0.5, "lines"),
    point.padding = unit(0.3, "lines")
  )

plot_file = paste(plots_dir, "b_vs_fraction_sig_correlations_pearson_pval_0.05.png", sep="/")
ggsave(
  plot_file,
  dpi = 1200,
  width = 6400,
  height = 6000,
  units = c("px")
)
```

```{r}
type_correlation_selected = "weak"
#sample_size_vs_a_df$data_col = ifelse(sample_size_vs_a_df$type_dataset == "gtex:whole.blood", "#E69F00", ifelse(sample_size_vs_a_df$type_dataset == "gtex:artery.tibial", "#D55E00", ifelse(sample_size_vs_a_df$type_dataset == "tcga:tcga-coad", "#56B4E9", ifelse(sample_size_vs_a_df$type_dataset == "tcga:tcga-brca", "#0072B2", "black"))))

sample_size_vs_a_df %>% 
  filter(type_correlation == type_correlation_selected) %>% 
  filter(!(type_dataset == "tcga:tcga")) %>% 
  mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:whole.blood", "GTEx: Whole blood")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:artery.tibial", "GTEx: Artery tibial")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-coad", "TCGA: Colon cancer")) %>%
  mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-brca", "TCGA: Breast cancer")) %>%
  ggplot(aes(x=a, y=unnorm_L)) + 
  geom_point() +
  geom_point(data = . %>% filter(type_dataset == "TCGA: Colon cancer"), color = "#56B4E9") +
  geom_point(data = . %>% filter(type_dataset == "TCGA: Breast cancer"), color = "#0072B2") +
  geom_point(data = . %>% filter(type_dataset == "R. arthritis"), color = "#44AA99") +
  geom_point(data = . %>% filter(type_dataset == "GTEx: Whole blood"), color = "#E69F00") +
  geom_point(data = . %>% filter(type_dataset == "GTEx: Artery tibial"), color = "#D55E00") +
  xlab(expression(alpha)) +
  ylab("L") +
  #guides(col=guide_legend(title="Dataset")) +
  theme_linedraw() +
  theme(aspect.ratio=1, plot.title =  element_text(size = 15, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 13), legend.text = element_text(size = 13), legend.title=element_text(size=14, face="bold")) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "gtex:whole.blood"),
    aes(label = type_dataset), col = "#E69F00",
    size = 5,
    box.padding = unit(0.5, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "gtex:artery.tibial"),
    aes(label = type_dataset), col = "#D55E00",
    size = 5,
    box.padding = unit(0.35, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected) %>% mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis"))), type_dataset == "R. arthritis"),
    aes(label = type_dataset), col = "#44AA99",
    size = 5,
    box.padding = unit(0.5, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "tcga:tcga-brca"),
    aes(label = type_dataset), col = "#0072B2",
    size = 5,
    box.padding = unit(0.35, "lines"),
    point.padding = unit(0.3, "lines")
  ) +
  geom_text_repel(
    data = subset((sample_size_vs_a_df %>% filter(type_correlation == type_correlation_selected)), type_dataset == "tcga:tcga-coad"),
    aes(label = type_dataset), col = "#56B4E9",
    size = 5,
    box.padding = unit(0.5, "lines"),
    point.padding = unit(0.3, "lines")
  )

plot_file = paste(plots_dir, "a_vs_L_pearson_pval_0.05.png", sep="/")
ggsave(
  plot_file,
  dpi = 1200,
  #width = 6400,
  #height = 6000,
  units = c("px")
)
```

```{r}
#(sample_size_vs_a_df %>% select("type_dataset", "a") %>% unique()) %>% inner_join((results_df %>% select("type_dataset", "size") %>% unique()), by=c("type_dataset")) %>%
#  group_by(type_dataset, a) %>%
#  summarize(max_size = max(size)) %>%
#  ggplot(aes(x=a, y=max_size)) + 
#  geom_point()
```


#### Levels of correlations plot

Define function to calculate critical sample size for correlation:

```{r}
calculate_sample_size_for_pearson_correlation_using_t_distribution_with_optimization = function(r, total_num_edges, alpha=0.05, N_guess=c(10000)){
  optimize_N = function(par){
    N = par[1]
    t_guess = qt(alpha, df=N-2, lower.tail = F)
    t = r * sqrt((N-2)) / sqrt((1-r**2))
    return((abs(t-t_guess)))
  }
  res = optim(par=N_guess, fn=optimize_N, method="Brent", lower=3, upper=50000)
  return(res$par)
}

calculate_sample_size_for_pearson_correlation_using_z_distribution_with_power = function(r, total_num_edges, alpha=0.05, power=0.8){
  alpha_corrected = alpha / total_num_edges # Correct alpha by multiple error
  Za = qnorm(alpha, lower.tail=F)
  Za_corrected = qnorm(alpha_corrected, lower.tail=F)
  Zb = qnorm(power, lower.tail=F)
  N = ((Za + Zb) / (0.5 * log((1+r)/(1-r))))**2 + 3
  N_corrected = ((Za_corrected + Zb) / (0.5 * log((1+r)/(1-r))))**2 + 3
  return(list(N=N, N_corrected=N_corrected))
}

calculate_sample_size_for_pearson_correlation_using_z_distribution = function(r, alpha=0.05){
  Za = qnorm(alpha, lower.tail=F)
  N = r / (2*Za - log((1+r)/(1-r))) + 1
  return(N)
}

calculate_sample_size_for_pearson_correlation_using_bonnet_and_wright = function(r, w, alpha=0.05){
  Za = qnorm(alpha, lower.tail=F)
  N0 = round(4 * (1-r**2)**2 * (Za/w)**2)
  L1 = 0.5 * (log(1+r) - log(1-r)) - Za/sqrt(N0-3)
  L2 = 0.5 * (log(1+r) - log(1-r)) + Za/sqrt(N0-3)
  w0 = ((exp(2*L2) - 1) / (exp(2*L2) + 1)) - ((exp(2*L1) - 1) / (exp(2*L1) + 1))
  N = ((N0 - 3) * (w0 / w)**2) + 3
  return(N)
}

calculate_predictions_using_stretched_exponential_model_optimized = function(x, L, a, b){
  y = L * exp((b*x**(-a+1))/(-a+1))
  #y = exp(log(L) - exp(b+a*log(x)))
  return(y)
}
```

Calculate sample size for different levels of correlation and different datasets:

```{r}
type_correlation_df = data.frame(type_correlation=c("weak", "moderate", "strong", "very strong"), lower_val=c(0.2,0.4,0.6,0.8), upper_val=c(0.4,0.6,0.8,NA))
types_correlation = c("weak", "moderate", "strong", "very strong")

cols = c("dataset", "type_correlation", "correlation", "sample_size_statistical", "sample_size_statistical_corrected", "sample_size_z")
sample_size_correlation_df = data.frame(matrix(ncol=length(cols),nrow=0, dimnames=list(NULL, cols)))
for (dataset in numbers_df$dataset){
  total_num_edges = (numbers_df %>% filter(dataset == !!dataset))$total_num_edges
  for (type_correlation in types_correlation){
    r = (type_correlation_df %>% filter(type_correlation == !!type_correlation))$lower_val
    N = calculate_sample_size_for_pearson_correlation_using_t_distribution_with_optimization(r=r, total_num_edges=total_num_edges, alpha=0.05, N_guess=c(10000))
    N_corrected = calculate_sample_size_for_pearson_correlation_using_t_distribution_with_optimization(r=r, total_num_edges=total_num_edges, alpha=0.05/total_num_edges, N_guess=c(10000))
    N_z = calculate_sample_size_for_pearson_correlation_using_bonnet_and_wright(r=r, w=0.8, alpha=0.05/total_num_edges)
    sample_size_correlation_df <- rbind(sample_size_correlation_df, data.frame(dataset=dataset, type_correlation=type_correlation, correlation=r, sample_size_statistical=N, sample_size_statistical_corrected=N_corrected, sample_size_z=N_z))
  }
}

print(sample_size_correlation_df)
```

```{r}
dataset_selected = "gtex:whole.blood"
model_selected = "Stretched exponential (by linear fit)"
results_analytical_gtex_wb = topology_results_selected_analytical_norm_df %>% 
  filter((model == model_selected) & (type_dataset == dataset_selected)) %>%
  select(model, type_dataset, a, b, L, max_value_in_dataset) %>% unique()
sample_size_correlation_gtex_wb = sample_size_correlation_df %>%
  filter((dataset == dataset_selected) & (!(type_correlation == "weak")))

predictions_convergence_gtex_wb_norm = calculate_predictions_using_stretched_exponential_model_optimized(x=sample_size_correlation_gtex_wb$sample_size_statistical_corrected, L=results_analytical_gtex_wb$L, a=results_analytical_gtex_wb$a, b=results_analytical_gtex_wb$b)
predictions_convergence_gtex_wb_df = data.frame(size=round(sample_size_correlation_gtex_wb$sample_size_statistical_corrected), num_edges=predictions_convergence_gtex_wb_norm * results_analytical_gtex_wb$max_value_in_dataset, num_edges_norm=predictions_convergence_gtex_wb_norm)
predictions_convergence_gtex_wb_df$num_edges_norm = (predictions_convergence_gtex_wb_df$num_edges/results_analytical_gtex_wb$max_value_in_dataset)/results_analytical_gtex_wb$L
predictions_convergence_gtex_wb_df

predicted_results_wb_df = predicted_results_df %>% filter((model == model_selected) & (type_dataset == dataset_selected)) %>% mutate_at(c('model_result'), as.numeric)
predicted_results_wb_df$model_result_norm = (predicted_results_wb_df$model_result/results_analytical_gtex_wb$max_value_in_dataset)/results_analytical_gtex_wb$L
```

```{r}
dataset_selected = "Whole.Blood"
all_topology_results_file = '/home/j.aguirreplans/Projects/Scipher/SampleSize/scripts/SampleSizeShiny/data/analysis_topology.csv'
threshold_selected = 0.05

all_results_df = fread(all_topology_results_file)
results_gtex_wb = all_results_df %>% 
  filter((type_dataset == dataset_selected) & (threshold == threshold_selected) & (type_correlation %in% c("weak-moderate-strong-very strong", "moderate-strong-very strong", "strong-very strong", "very strong")))
results_gtex_wb$num_edges_norm = (results_gtex_wb$num_edges/results_analytical_gtex_wb$max_value_in_dataset)/results_analytical_gtex_wb$L

results_gtex_wb %>% 
  mutate(type_correlation = replace(type_correlation, type_correlation == "weak-moderate-strong-very strong", "\u2265 0.2")) %>%
  mutate(type_correlation = replace(type_correlation, type_correlation == "moderate-strong-very strong", "\u2265 0.4")) %>%
  mutate(type_correlation = replace(type_correlation, type_correlation == "strong-very strong", "\u2265 0.6")) %>%
  mutate(type_correlation = replace(type_correlation, type_correlation == "very strong", "\u2265 0.8")) %>%
  ggplot(aes(x=size, y=num_edges_norm, col=type_correlation)) +
  geom_point(alpha=0.5, size=3) +
  geom_line(data=(predicted_results_wb_df %>% filter(size <= max((all_results_df %>% filter((type_dataset == dataset_selected) & (threshold == threshold_selected)))$size))), aes(x=size, y=model_result_norm), size=1, color='red') +
  geom_point(data=predictions_convergence_gtex_wb_df, 
           aes(x=size,y=num_edges_norm), 
           color='red',
           size=3) +
  #scale_x_continuous(trans = scales::log10_trans()) +
  #scale_color_manual(values = c("#D55E00", "#E69F00", "#44AA99", "#0072B2", "#56B4E9")) +
  theme_linedraw() +
  xlab("Number of samples") +
  #xlab("log(N)") +
  ylab("Fraction of significant correlations") +
  guides(col=guide_legend(title="Correlation strength")) +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 16, face="bold"), axis.text = element_text(size = 15), legend.text = element_text(size = 14), legend.title=element_text(size=15, face="bold"))

plot_file = paste(plots_dir, "correlation_levels_pearson_pval_0.05_data_gtexwholeblood.png", sep="/")
ggsave(
  plot_file,
  dpi = 1200,
  width = 9000,
  height = 6000,
  units = c("px")
)
```


#### Disease modules plot

```{r}
all_disease_genes_results_file = '/home/j.aguirreplans/Projects/Scipher/SampleSize/scripts/SampleSizeShiny/data/analysis_disease_genes.csv'
plots_disease_module_dir = paste(plots_dir, 'plots_disease_module', sep='/')
dir.create(plots_disease_module_dir, showWarnings = FALSE)
threshold_selected = 0.05

all_disease_genes_results_df = fread(all_disease_genes_results_file)
all_disease_genes_results_df$type_dataset = paste(all_disease_genes_results_df$dataset, all_disease_genes_results_df$type_dataset, sep=":") # Join dataset and type_dataset
all_disease_genes_results_df$type_dataset = tolower(all_disease_genes_results_df$type_dataset)

dataset_selected = "scipher:scipher.complete.dataset"
results_scipher_df = all_disease_genes_results_df %>%
  filter((type_dataset == dataset_selected) & (threshold == threshold_selected))
head(results_scipher_df)

dataset_selected = "gtex:whole.blood"
results_wholeblood_df = all_disease_genes_results_df %>%
  filter((type_dataset == dataset_selected) & (threshold == threshold_selected))
head(results_wholeblood_df)

dataset_selected = "gtex:breast.mammary.tissue"
results_breast_df = all_disease_genes_results_df %>%
  filter((type_dataset == dataset_selected) & (threshold == threshold_selected))
head(results_breast_df)

dataset_selected = "tcga:tcga-brca"
results_tcgabrca_df = all_disease_genes_results_df %>%
  filter((type_dataset == dataset_selected) & (threshold == threshold_selected))
head(results_tcgabrca_df)
```


Compare correlation strength for the rLCC of a specific disease module in a specific gene co-expression dataset:

```{r}
#datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "gtex:whole.blood", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")
datasets_selected = c("scipher:scipher.complete.dataset")
#diseases_selected = c("arthritis rheumatoid", "breast neoplasms", "thyroid neoplasms")
diseases_selected = c("arthritis rheumatoid")
module_rlcc_by_correlation_plots = list()

for (x in 1:length(datasets_selected)){
  dataset_selected = datasets_selected[x]
  for (y in 1:length(diseases_selected)){
    disease_selected = diseases_selected[y]
    module_rlcc_by_correlation_plot = all_disease_genes_results_df %>%
      filter(disease == disease_selected) %>%
      filter((type_dataset == dataset_selected) & (threshold == 0.05) & (type_correlation %in% c("weak-moderate-strong-very strong", "moderate-strong-very strong", "strong-very strong", "very strong"))) %>%
      mutate(type_correlation = replace(type_correlation, type_correlation == "weak-moderate-strong-very strong", "\u2265 0.2")) %>%
      mutate(type_correlation = replace(type_correlation, type_correlation == "moderate-strong-very strong", "\u2265 0.4")) %>%
      mutate(type_correlation = replace(type_correlation, type_correlation == "strong-very strong", "\u2265 0.6")) %>%
      mutate(type_correlation = replace(type_correlation, type_correlation == "very strong", "\u2265 0.8")) %>%
      group_by(size, type_correlation) %>%
      mutate(mean_rlcc = mean(fraction_disease_lcc_nodes)) %>%
      ungroup() %>%
      ggplot() +
      geom_point(aes(x=size, y=fraction_disease_lcc_nodes, col=type_correlation), alpha=0.4, size=3) +
      geom_line(aes(x=size, y=mean_rlcc, col=type_correlation), size=1) +
      #scale_x_continuous(trans = scales::log10_trans()) +
      #scale_color_manual(values = c("#D55E00", "#E69F00", "#44AA99", "#0072B2", "#56B4E9")) +
      theme_linedraw() +
      guides(col=guide_legend(title="Correlation strength")) +
      xlab("Number of samples") +
      #xlab("log(N)") +
      ylab("Disease genes fraction in LCC") +
      theme(aspect.ratio=1, 
            plot.title =  element_text(size = 15, face="bold"), 
            axis.title = element_text(size = 14, face="bold"), 
            axis.text = element_text(size = 13), 
            legend.text = element_text(size = 13), 
            legend.title=element_text(size=14, face="bold"))
    
    module_rlcc_by_correlation_plots[[((x-1)*length(datasets_selected) + y)]] = module_rlcc_by_correlation_plot
    print(module_rlcc_by_correlation_plot)
    plot_file = paste(plots_disease_module_dir, "/disease_module_rlcc_by_correlations_pearson_pval_0.05_data_", gsub(':', '.', dataset_selected), "_disease_", gsub(' ', '.', disease_selected), ".png", sep="")
    ggsave(
      plot_file,
      plot = module_rlcc_by_correlation_plot,
      dpi = 1200,
      #width = 9300,
      #height = 6000,
      units = c("px")
    )
  }
}
```

Compare correlation strength for the LCC significance of a specific disease module in a specific gene co-expression dataset:

```{r}
#datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "gtex:whole.blood", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")
datasets_selected = c("scipher:scipher.complete.dataset")
#diseases_selected = c("arthritis rheumatoid", "breast neoplasms", "thyroid neoplasms")
diseases_selected = c("arthritis rheumatoid")
module_signif_by_correlation_plots = list()
for (x in 1:length(datasets_selected)){
  dataset_selected = datasets_selected[x]
  for (y in 1:length(diseases_selected)){
    disease_selected = diseases_selected[y]
    module_signif_by_correlation_plot = all_disease_genes_results_df %>%
      filter(disease == disease_selected) %>%
      filter((type_dataset == dataset_selected) & (threshold == 0.05) & (type_correlation %in% c("weak-moderate-strong-very strong", "moderate-strong-very strong", "strong-very strong", "very strong"))) %>%
      mutate(type_correlation = replace(type_correlation, type_correlation == "weak-moderate-strong-very strong", "\u2265 0.2")) %>%
      mutate(type_correlation = replace(type_correlation, type_correlation == "moderate-strong-very strong", "\u2265 0.4")) %>%
      mutate(type_correlation = replace(type_correlation, type_correlation == "strong-very strong", "\u2265 0.6")) %>%
      mutate(type_correlation = replace(type_correlation, type_correlation == "very strong", "\u2265 0.8")) %>%
      group_by(size, type_correlation) %>%
      mutate(mean_pval = mean(disease_lcc_pvalue)) %>%
      ungroup() %>%
      mutate(disease_lcc_pvalue = replace(disease_lcc_pvalue, disease_lcc_pvalue < 0.000001, 0.000001)) %>%
      mutate(mean_pval = replace(mean_pval, mean_pval < 0.000001, 0.000001)) %>%
      ggplot() +
      geom_point(aes(x=size, y=abs(log10(disease_lcc_pvalue)), col=type_correlation), alpha=0.4, size=3) +
      geom_line(aes(x=size, y=abs(log10(mean_pval)), col=type_correlation), size=1) +
      geom_hline(yintercept=as.numeric(abs(log10(0.05))), linetype="dashed", color="red", size=0.5) +
      #scale_x_continuous(trans = scales::log10_trans()) +
      #scale_color_manual(values = c("#D55E00", "#E69F00", "#44AA99", "#0072B2", "#56B4E9")) +
      theme_linedraw() +
      guides(col=guide_legend(title="Correlation strength")) +
      xlab("Number of samples") +
      #xlab("log(N)") +
      ylab("Disease LCC log p-value (abs)") +
      theme(aspect.ratio=1, 
            plot.title =  element_text(size = 15, face="bold"), 
            axis.title = element_text(size = 14, face="bold"), 
            axis.text = element_text(size = 13), 
            legend.text = element_text(size = 13), 
            legend.title=element_text(size=14, face="bold"))
    
    module_signif_by_correlation_plots[[((x-1)*length(datasets_selected) + y)]] = module_signif_by_correlation_plot
    print(module_signif_by_correlation_plot)
    plot_file = paste(plots_disease_module_dir, "/disease_module_significance_by_correlations_pearson_pval_0.05_data_", gsub(':', '.', dataset_selected), "_disease_", gsub(' ', '.', disease_selected), ".png", sep="")
    ggsave(
      plot_file,
      plot = module_signif_by_correlation_plot,
      dpi = 1200,
      #width = 9000,
      #height = 6000,
      units = c("px")
    )
  }
}
```


Compare disease module significance of different disease-gene associations for specific dataset and correlation type:

```{r}
name2color <- c("arthritis rheumatoid"="#65F3BF", "asthma"="#d9f365", "breast neoplasms"="#0072B2", "thyroid neoplasms"="#56B4E9")
#datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "gtex:whole.blood", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")
datasets_selected = c("scipher:scipher.complete.dataset")
#types_correlation = c("all", "weak-moderate-strong-very strong", "moderate-strong-very strong", "strong-very strong", "very strong")
types_correlation = c("all")
#diseases_selected = c("arthritis rheumatoid", "asthma", "breast neoplasms", "heart failure")
diseases_selected = c("arthritis rheumatoid", "breast neoplasms", "thyroid neoplasms")
module_signif_by_disease_plots = list()
for (x in 1:length(datasets_selected)){
  dataset_selected = datasets_selected[x]
  for (y in 1:length(types_correlation)){
    type_correlation_selected = types_correlation[y]
    module_signif_by_disease_plot = all_disease_genes_results_df %>%
      filter((type_dataset == dataset_selected) & (threshold == 0.05)) %>%
      filter((disease %in% diseases_selected) & (type_correlation == type_correlation_selected)) %>%
      group_by(size, disease) %>%
      summarize(mean_pval = mean(disease_lcc_pvalue)) %>%
      mutate(mean_pval = replace(mean_pval, mean_pval < 0.000001, 0.000001)) %>%
      mutate(disease = replace(disease, disease == "arthritis rheumatoid", "R. arthritis")) %>%
      mutate(disease = replace(disease, disease == "breast neoplasms", "Breast cancer")) %>%
      mutate(disease = replace(disease, disease == "thyroid neoplasms", "Thyroid cancer")) %>%
      ggplot(aes(x=size, y=abs(log10(mean_pval)), col=disease)) +
      #geom_point(alpha=0.5, size=3) +
      geom_line(size=1) +
      geom_hline(yintercept=as.numeric(abs(log10(0.05))), linetype="dashed", color="red", size=0.5) +
      #scale_x_continuous(trans = scales::log10_trans()) +
      scale_color_manual(values = c(name2color["breast neoplasms"][[1]], name2color["arthritis rheumatoid"][[1]], name2color["thyroid neoplasms"][[1]])) +
      theme_linedraw() +
      xlab("Number of samples") +
      #xlab("log(N)") +
      ylab("Disease LCC log p-value (abs)") +
      guides(col=guide_legend(title="Disease-gene associations")) +
      theme(aspect.ratio=1, 
            plot.title =  element_text(size = 15, face="bold"), 
            axis.title = element_text(size = 14, face="bold"), 
            axis.text = element_text(size = 13), 
            legend.text = element_text(size = 13), 
            legend.title=element_text(size=14, face="bold"))
    
    module_signif_by_disease_plots[[((x-1)*length(datasets_selected) + y)]] = module_signif_by_disease_plot
    print(module_signif_by_disease_plot)
    plot_file = paste(plots_disease_module_dir, "/disease_module_significance_by_diseases_pearson_pval_0.05_data_", gsub(':', '.', dataset_selected), "_correlation_", gsub(' ', '.', type_correlation_selected), ".png", sep="")
    ggsave(
      plot_file,
      plot=module_signif_by_disease_plot,
      dpi = 1200,
      #width = 9700,
      #height = 6000,
      units = c("px")
    )
  }
}
```

Compare datasets for the LCC significance of a specific disease module and type of correlation:

```{r}
#diseases_selected = c("arthritis rheumatoid", "breast neoplasms", "thyroid neoplasms")
diseases_selected = c("arthritis rheumatoid")
#types_correlation = c("all", "weak-moderate-strong-very strong", "moderate-strong-very strong", "strong-very strong", "very strong")
types_correlation = c("all")
datasets_selected = c("gtex:breast.mammary.tissue", "gtex:thyroid", "gtex:whole.blood", "tcga:tcga-brca", "tcga:tcga-thca", "scipher:scipher.complete.dataset")

module_signif_by_dataset_plots = list()
for (x in 1:length(diseases_selected)){
  disease_selected = diseases_selected[x]
  for (y in 1:length(types_correlation)){
    type_correlation_selected = types_correlation[y]
    module_signif_by_dataset_plot = all_disease_genes_results_df %>%
      filter((disease == disease_selected) & (type_dataset %in% datasets_selected) & (threshold == threshold_selected) & (type_correlation == type_correlation_selected)) %>%
      mutate(type_dataset = replace(type_dataset, type_dataset == "scipher:scipher.complete.dataset", "R. arthritis")) %>%
      mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:whole.blood", "GTEx: W. blood")) %>%
      mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:thyroid", "GTEx: Thyroid")) %>%
      mutate(type_dataset = replace(type_dataset, type_dataset == "gtex:breast.mammary.tissue", "GTEx: Breast")) %>%
      mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-thca", "TCGA: Thyroid cancer")) %>%
      mutate(type_dataset = replace(type_dataset, type_dataset == "tcga:tcga-brca", "TCGA: Breast cancer")) %>%
      group_by(size, type_dataset) %>%
      mutate(mean_pval = mean(disease_lcc_pvalue)) %>%
      ungroup() %>%
      mutate(disease_lcc_pvalue = replace(disease_lcc_pvalue, disease_lcc_pvalue < 0.000001, 0.000001)) %>%
      ggplot() +
      geom_point(aes(x=size, y=abs(log10(disease_lcc_pvalue)), col=type_dataset), alpha=0.5, size=3) +
      #geom_line(aes(x=size, y=abs(log10(mean_pval)), col=type_dataset), size=1) +
      geom_hline(yintercept=as.numeric(abs(log10(0.05))), linetype="dashed", color="red", size=0.5) +
      #scale_x_continuous(trans = scales::log10_trans()) +
      #scale_color_manual(values = c("#D55E00", "#E69F00", "#44AA99", "#0072B2", "#56B4E9")) +
      scale_color_manual(values = c("#D55E00", "#E69F00", "#44AA99", "#65F3BF", "#0072B2", "#56B4E9")) +
      theme_linedraw() +
      guides(col=guide_legend(title="Dataset")) +
      xlab("Number of samples") +
      #xlab("log(N)") +
      ylab("Disease LCC log p-value (abs)") +
      theme(aspect.ratio=1, 
            plot.title =  element_text(size = 15, face="bold"), 
            axis.title = element_text(size = 14, face="bold"), 
            axis.text = element_text(size = 13), 
            legend.text = element_text(size = 13), 
            legend.title=element_text(size=14, face="bold"))
    
    module_signif_by_dataset_plots[[((x-1)*length(diseases_selected) + y)]] = module_signif_by_dataset_plot
    print(module_signif_by_dataset_plot)
    plot_file = paste(plots_disease_module_dir, "/disease_module_significance_by_dataset_pearson_pval_0.05_disease_", gsub(' ', '.', disease_selected), "_correlation_", gsub(' ', '.', type_correlation_selected), ".png", sep="")
    ggsave(
      plot_file,
      plot = module_signif_by_dataset_plot,
      dpi = 1200,
      #width = 9200,
      #height = 6000,
      units = c("px")
    )
  }
}
```

Create a panel with the disease module study results:

```{r}
# Use patchwork to concatenate plots
(((module_rlcc_by_correlation_plots[[1]] | module_signif_by_correlation_plots[[1]]) + 
    plot_layout(guides = 'collect') &
    guides(col=guide_legend(title="Correlation strength", title.position="top", nrow=1,byrow=TRUE)) & # Place legend in two columns
    theme(legend.position = 'bottom', legend.text = element_text(size = 11),  legend.title=element_text(size=13, face="bold"))) / # Place legend at the bottom
   ((module_signif_by_disease_plots[[1]] + 
       guides(col=guide_legend(title="Disease-gene associations", title.position="top", nrow=3,byrow=TRUE)) +
       theme(legend.position = 'bottom', legend.text = element_text(size = 11),  legend.title=element_text(size=13, face="bold"))) | 
    (module_signif_by_dataset_plots[[1]] + 
       guides(col=guide_legend(title="Dataset", title.position="top", nrow=3,byrow=TRUE)) +
       theme(legend.position = 'bottom', legend.text = element_text(size = 11),  legend.title=element_text(size=13, face="bold"))))) + 
  plot_layout(widths = c(1,1)) &
  plot_annotation(tag_levels = 'A') & # Include letters 
    theme(plot.tag = element_text(face = 'bold'), legend.text = element_text(size = 11)) # that are bold

plot_file = paste(plots_disease_module_dir, "/disease_module_results.png", sep="")
ggsave(
  plot_file,
  dpi = 1200,
  width = 11000,
  height = 13500,
  units = c("px")
)

```
