---
title: "Analyze changes in individual edges"
author: "Joaquim Aguirre-Plans"
date: "4/27/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Description

Analyze the evolution correlation in individual edges.

```{r, message=FALSE}
library(data.table)
library(dplyr)
library(ggplot2)
library(igraph)
require(magrittr)
library(optparse)
#library(som)
library(tidyr)
set.seed(1510)
`%ni%` <- Negate(`%in%`)
```


## Read files

```{r}
# Define dataframe
#networks_file = "/scratch/j.aguirreplans/Scipher/SampleSize/networks_tcga/tcga_TCGA_pearson_combined.txt"
#networks_file = "/scratch/j.aguirreplans/Scipher/SampleSize/networks_gtex/gtex_Whole.Blood_pearson_combined.txt"
networks_file = "/scratch/j.aguirreplans/Scipher/SampleSize/networks_gtex/gtex_Whole.Blood_pearson_combined_dummy.txt"
#networks_file = "/scratch/j.aguirreplans/Scipher/SampleSize/networks_scipher/scipher_complete.dataset_pearson_combined.txt"

plots_dir = '/home/j.aguirreplans/Projects/Scipher/SampleSize/data/out/plots'

#som_plot_file = paste(plots_dir, "tcga_TCGA_pearson_som.png", sep="/")
som_plot_file = paste(plots_dir, "gtex_dummy_pearson_som.png", sep="/")
hist_plot_file = paste(plots_dir, "gtex_dummy_pearson_hist.png", sep="/")
hist_gp_plot_file = paste(plots_dir, "gtex_dummy_pearson_hist_by_size.png", sep="/")
```

We read the file containing the networks all together:

```{r}
networks_df = fread(networks_file, header=T)
```

```{r}
networks_df[1:10,1:5]
```

The networks dataframe contains `r ncol(networks_df)` networks of `r nrow(networks_df)` edges.

Using the package `som`:

```{r}
norm = som::normalize(networks_df[,!(c("Node.1","Node.2"))], byrow=TRUE)
som_vars <- som::som(norm, xdim=1, ydim=5)
max_val = ceiling(max(norm))
min_val = floor(min(norm))
```

```{r}
plot(som_vars, ylim=c(-5, 5))
png(file=som_plot_file,
    width=10000, 
    height=6000,
    units = c("px")
)
dev.off()
```


```{r}
networks_long = networks_df %>% 
  mutate(gp = paste(Node.1, Node.2, sep = " -- ")) %>%
  select(!(c(Node.1, Node.2))) %>%
  group_by(gp) %>%
  pivot_longer(!gp, names_to = "ss.rep", values_to = "score") %>%
  mutate(sd=sd(score)) %>%
  ungroup() %>% 
  separate("ss.rep", into=c("ss", "rep"), sep="[.]")

networks_long$ss = as.integer(networks_long$ss)
networks_long$rep = as.integer(networks_long$rep)

networks_long %<>% group_by(ssgr=cut(ss, breaks= seq(0, 800, by = 100))) %>%
  ungroup() %>%
  group_by(gp, ssgr) %>%
  mutate(sdgr=sd(score)) %>%
  ungroup()

ggplot((networks_long %>% select(gp, sd) %>% unique()), aes(x=sd)) + geom_histogram(binwidth = 0.01, alpha=0.8, color=2, fill=2)
ggsave(
  hist_plot_file,
  dpi = 1200,
  width = 10000,
  height = 6000,
  units = c("px")
)

ggplot((networks_long %>% select(gp, sdgr, ssgr) %>% unique()), aes(x=sdgr, fill=ssgr, color=ssgr)) + geom_histogram(binwidth = 0.01, alpha=0.5)
ggsave(
  hist_gp_plot_file,
  dpi = 1200,
  width = 10000,
  height = 6000,
  units = c("px")
)
```

