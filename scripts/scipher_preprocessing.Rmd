---
title: "scipher_preprocessing"
author: "Joaquim Aguirre-Plans & Deisy Morselli Gysi"
date: "1/11/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Description

Preprocess Scipher data (version v8).

```{r, message=FALSE}
library(data.table)
library(dplyr)
library(ggplot2)
library(tidyr)
set.seed(1510)
```

## Read files

```{r define_files}
# Define working directories
databases_dir = '/home/j.aguirreplans/Databases'
ppi_dir = '/home/j.aguirreplans/data/PPI'
deisy_dicts_dir = '/home/j.aguirreplans/data/DeisyDictionaries'
data_dir = '/home/j.aguirreplans/Projects/Scipher/SampleSize/data/Dec2021'

# Define input files
RNAseq_raw_file = paste(data_dir, '00_data/Network004_hg19_ucsc_counts_20211027.csv', sep='/')
metadata_file = paste(data_dir, '00_data/RA-netk042021-10-25.xlsx', sep='/')
ppi_network_symbol_file = paste(ppi_dir, 'interactome_2019_merged_symbols.csv', sep='/')
mesh_file = paste(databases_dir, 'MeSH/mtrees2021.bin', sep='/')
metadata_file = paste(data_dir, '00_data/RA-netk042021-10-25.xlsx', sep='/')
disease_genes_file = "/home/j.aguirreplans/Projects/Scipher/SampleSize/data/Guney2016_GenesDisease.tsv"
essential_genes_original_file = paste(databases_dir, 'OGEE/OGEE_esential_genes_20190416.txt', sep='/')

# Define output files and dirs
metadata_RNA_file = paste(data_dir, '00_data/scipher_metadata_rnaseq_counts.csv', sep='/')
metadata_RNA_0m_file = paste(data_dir, '00_data/scipher_metadata_rnaseq_counts_0m.csv', sep='/')
RNAseq_processed_file = paste(data_dir, '00_data/scipher_rnaseq_counts_processed.csv', sep='/')
genes_dataset_file = paste(data_dir, '00_data/scipher_rnaseq_gene_info.csv', sep='/')
disease_genes_info_file = "/home/j.aguirreplans/Projects/Scipher/SampleSize/data/disease_genes/disease_genes_info.csv"
disease_genes_info_scipher_file = "/home/j.aguirreplans/Projects/Scipher/SampleSize/data/disease_genes/disease_genes_info_scipher.csv"
essential_genes_file = paste(databases_dir, 'OGEE/OGEE_esential_genes.csv', sep='/')
essential_genes_scipher_file = '/home/j.aguirreplans/Projects/Scipher/SampleSize/data/essential_genes/OGEE_esential_genes_scipher.csv'

```

> Important to note: There are many samples that have the same Scipher_id, meaning that they come from the same patient. They only differ by the visit (which can be either 0m, 3m or 6m) and the "batch" (which can be either "seq_fac1" or "seq_fac2").

```{r read_files}
# Read file with gene counts
RNAseq_raw = fread(RNAseq_raw_file)
names(RNAseq_raw) %>% head(n = 20)
names(RNAseq_raw) %>% tail(n = 20)

# Merge Scipher_id, visit and batch into a unique id
scipherid_visit_batch = paste(RNAseq_raw$Scipher_id, RNAseq_raw$visit, RNAseq_raw$batch, sep=".")
RNAseq_raw = cbind(data.frame(Scipher_id.visit.batch=scipherid_visit_batch), RNAseq_raw)

```

The `RNAseq_raw` contains `r ncol(RNAseq_raw)` features, from `r nrow(RNAseq_raw)` samples

> **Note: Gene names must be remapped from the USCS format to an official name system - such as HGNC or ENTREZ. For that, one can use, for example, biomart.**

We filter the genes in the RNAseq keeping only the ones that have known gene symbol.

```{r read_genes, echo=FALSE, results='hide'}
# Filter genes with symbol information
gene_info_file = paste(databases_dir, 'NCBIGene/Homo_sapiens.gene_info', sep='/')
gene_info_df = fread(gene_info_file)
#gene_info_df = gene_info_df %>% separate_rows(Synonyms, convert = TRUE)
gene_info_df$Symbol = toupper(gene_info_df$Symbol)
gene_info_df$Synonyms = toupper(gene_info_df$Synonyms)

names(RNAseq_raw)[9:length(names(RNAseq_raw))] = toupper(names(RNAseq_raw)[9:length(names(RNAseq_raw))])
genes_dataset = names(RNAseq_raw)[9:length(names(RNAseq_raw))]
genes_dataset_df = data.frame(Name=genes_dataset, Symbol=genes_dataset) %>% inner_join((gene_info_df %>% dplyr::select(Symbol, GeneID)), by="Symbol") %>% unique()
#gene_synonyms_dataset = genes_dataset[(toupper(genes_dataset) %in% toupper(unique(gene_info_df$Synonyms))) & !(toupper(genes_dataset) %in% toupper(unique(gene_info_df$Symbol)))]
#gene_synonyms_dataset_df = data.frame(Gene=gene_synonyms_dataset, Synonyms=toupper(gene_synonyms_dataset)) %>% inner_join((gene_info_df %>% dplyr::select(Symbol, Synonyms, GeneID)), by="Synonyms") %>% unique()

genes_not_symbol = genes_dataset[(!genes_dataset %in% unique(genes_dataset_df$Name))]
#genes_not_symbol = genes_not_symbol[(!(toupper(gsub("_", "", genes_not_symbol))) %in% toupper(all_genes_and_synonyms))]

gene_names_dict_file = paste(deisy_dicts_dir, 'Gene_Names_Dic.csv', sep='/')
gene_names_dict = fread(gene_names_dict_file)
gene_names_dict$Symbol = toupper(gene_names_dict$Symbol)
gene_names_dict$Alias = toupper(gene_names_dict$Alias)
gene_names_dict = inner_join(gene_names_dict, (gene_info_df %>% select(Symbol, GeneID)), by="Symbol")
gene_names_dict_dataset_df = data.frame(Alias=genes_not_symbol) %>% inner_join((gene_names_dict), by="Alias") %>% unique()
genes_dataset_df = rbind(genes_dataset_df, (gene_names_dict_dataset_df %>% filter(!(Symbol %in% genes_dataset_df$Symbol)) %>% rename("Name"="Alias")))
fwrite(genes_dataset_df, genes_dataset_file)

genes_not_symbol = genes_dataset[!(genes_dataset %in% unique(genes_dataset_df$Name))]

RNA = RNAseq_raw %>% select(genes_dataset_df$Name)

```

We end up having `r ncol(RNA)` features, from `r nrow(RNA)` samples

There are also `r length(genes_not_symbol)` genes without a symbol known in NCBI gene database. Here we show several of these genes:

```{r genes_without_symbol, echo=FALSE}
genes_not_symbol[1:100]

```

```{r read_metadata, echo=FALSE, results='hide'}
# Read file with metadata
metadata = readxl::read_xlsx(metadata_file)

```

Regarding the metadata, we have `r ncol(metadata$Scipher_id)` features, from `r length(unique(metadata$Scipher_id))` unique individuals. The majory of the patients have more than one visit.


## Filtering the genes with low counts

We filter the genes that have low expression in all samples, keeping the ones that meet at least 3 of these 4 rules:

* Sum of the expression of all samples above 0.
* Mean of the expression of all samples above 5.
* Median of the expression of all samples above 5.
* Standard deviation of all samples above 1.

```{r, echo=FALSE, results='hide'}
sum = colSums(RNA)
mean = colMeans(RNA)
med = apply(RNA, 2, median)
sd = apply(RNA, 2,sd)

sumG = sum[sum > 0]
meanG = mean[mean > 5]
sdG = sd[sd > 1]
medG = med[med > 5]

keep = data.frame(Gene = c(names(sumG), 
                           names(meanG),
                           names(sdG), 
                           names(medG))) %>% 
        group_by(Gene) %>% 
        summarise(., n = n()) %>% 
        filter(n >= 3)
rm(RNA)

```

```{r, echo=FALSE, results='hide'}
RNAseq_processed = RNAseq_raw %>% select(names(RNAseq_raw)[1:7], keep$Gene)
rm(RNAseq_raw)
RNAseq_processed_t = t(as.matrix(RNAseq_processed %>% select(Scipher_id.visit.batch, keep$Gene))) %>% as.data.frame()
genes = rownames(RNAseq_processed_t[2:nrow(RNAseq_processed_t),])
samples = as.character(RNAseq_processed_t[1,])
colnames(RNAseq_processed_t) = samples
RNAseq_processed_t = cbind(data.frame(Gene=genes), RNAseq_processed_t[2:nrow(RNAseq_processed_t),])
fwrite(RNAseq_processed_t, RNAseq_processed_file)

```

We end up having `r length(keep$Gene)` genes and `r nrow(RNAseq_processed)` samples from `r length(unique(RNAseq_processed$Scipher_id))` individuals.


## Combining the dataset

```{r, echo=FALSE, results='hide'}
metadata = metadata %>% 
  rename(CRP_metadata = CRP)

metadata_RNA = dplyr::inner_join(metadata, RNAseq_processed)
fwrite(metadata_RNA, metadata_RNA_file)

```

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
metadata_response = 
  metadata %>%
  select(Scipher_id, visit, 
         eular_binary, acr50) %>%
  pivot_wider(names_from = visit, 
              values_from = c(eular_binary, acr50))
```

When combining the metadata with the RNAseq we have, in total, `r nrow(metadata_RNA)` samples from `r length(unique(metadata_RNA$Scipher_id))` individuals. Out of those, **`r nrow(metadata_RNA[metadata_RNA$visit == "0m", ])`** samples from `r length(unique(metadata_RNA[metadata_RNA$visit == "0m", ]$Scipher_id))` individuals are at baseline.

> Important to note: The key to both data sets is the combination of `Scipher_id` and `visit`. Do not join using `CRP`.

We focus here on the data we have in the baseline. 

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
RNAseq_processed_0m = RNAseq_processed %>%
  filter(visit == "0m")

metadata_RNA_0m = dplyr::inner_join(metadata_response, RNAseq_processed_0m)
fwrite(metadata_RNA_0m, metadata_RNA_0m_file)

```

```{r, echo=FALSE, results='asis'}
metadata_RNA_0m %>% 
  group_by(eular_binary_3m) %>% 
  summarise(`#` = n()) %>%
  ungroup() %>%
  mutate(`%` = round((`#`/n()), 2))
```

```{r, echo=FALSE, results='asis'}
metadata_RNA_0m %>% 
  group_by(eular_binary_6m) %>% 
  summarise(`#` = n()) %>%
  ungroup() %>%
  mutate(`%` = round((`#`/n()), 2))
```

```{r, echo=FALSE, results='asis', warning=FALSE, message=FALSE}
metadata_RNA_0m %>% 
  group_by(eular_binary_3m, eular_binary_6m) %>%
  summarise(`#` = n()) %>%
  ungroup() %>%
  mutate(`%` = round((`#`/n()), 2))
```


## Prepare disease genes information dataset

```{r}
# Create a disease gene file containing MESH information
if(!(file.exists(disease_genes_info_file))){
  
  # Parse MESH
  mesh_df = fread(mesh_file, header=FALSE, col.names = c("concept", "concept.id"))
  mesh_df$root.concept.id = substr(mesh_df$concept.id,1,3)
  root.concepts = mesh_df %>% filter(concept.id==root.concept.id) %>% select(concept, concept.id) %>% rename("root.concept"="concept", "root.concept.id"="concept.id")
  mesh_df = left_join(mesh_df, root.concepts, by=c("root.concept.id" = "root.concept.id"))
  mesh_df$concept = tolower(mesh_df$concept)
  mesh_df$root.concept = tolower(mesh_df$root.concept)
  
  # Parse disease2gene
  processDisease2Genes = function(filepath) {
    disease_genes_df=data.frame(matrix(ncol=2,nrow=0, dimnames=list(NULL, c("disease", "gene.id"))))
    con = file(filepath, "r")
    while ( TRUE ) {
      line = readLines(con, n = 1)
      if ( length(line) == 0 ) {
        break
      }
      lineValues=strsplit(line, split="\t")[[1]]
      disease=lineValues[2]
      genes=lineValues[3:length(lineValues)]
      disease2genes=data.frame(disease=disease,gene.id=genes)
      disease_genes_df=rbind(disease_genes_df, disease2genes)
    }
    close(con)
    return(disease_genes_df)
  }
  disease_genes_df = processDisease2Genes(disease_genes_file)
  disease_genes_df$gene.id = as.numeric(disease_genes_df$gene.id)
  
  # Parse gene info
  gene_info_file = '/home/j.aguirreplans/Databases/NCBIGene/Homo_sapiens.gene_info'
  gene_info_df = fread(gene_info_file) %>% select(GeneID, Symbol)
  gene_info_df$Symbol = toupper(gene_info_df$Symbol)
  
  # Merge disease2gene with gene info to include gene symbols
  disease_genes_df = inner_join(disease_genes_df, gene_info_df, by=c("gene.id" = "GeneID")) %>% rename("gene"="Symbol")
  
  # Merge disease2gene table with MESH and output file
  disease_genes_df = inner_join(disease_genes_df, mesh_df, by=c("disease" = "concept"))

  # Make columns without special characgters  
  disease_genes_df$disease.no.sp.char <- gsub(' ', '.', gsub(', ', '.', gsub('-', '.', gsub('[\\(\\)]', '', disease_genes_df$disease))))
  disease_genes_df$root.concept.no.sp.char <- gsub(' ', '.', gsub(', ', '.', gsub('-', '.', gsub('[\\(\\)]', '', disease_genes_df$root.concept))))

  disease_genes_df %>% fwrite(disease_genes_info_file)
  
} else {
  disease_genes_df = fread(disease_genes_info_file)
}

```

```{r}
#disease_genes_scipher_df = disease_genes_df %>% filter(gene %in% names(RNAseq_processed))
#disease_genes_scipher_df %>% fwrite(disease_genes_info_scipher_file)

```

## Prepare essencial genes dataset

```{r}
essential_genes_df = fread(essential_genes_original_file, header=TRUE) %>% rename("taxID"="#taxID")
essential_genes_df = essential_genes_df %>% filter((taxID == 9606) & (essential=="E"))
gene_info_df = fread(gene_info_file)
gene_info_df = gene_info_df %>% separate_rows(dbXrefs, convert = TRUE) %>% select(Symbol, dbXrefs) %>% unique()
essential_genes_df = essential_genes_df %>% left_join(gene_info_df, by=c("locus"="dbXrefs")) %>% rename("gene"="Symbol")
essential_genes_df %>% fwrite(essential_genes_file)
```

```{r}
#essential_genes_scipher_df = essential_genes_df %>% filter(gene %in% names(RNAseq_processed))
#essential_genes_scipher_df %>% fwrite(essential_genes_scipher_file)

```


