---
title: "Calculate random model as alpha = 0"
author: "Joaquim Aguirre-Plans"
date: '2023-05-29'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Description

Let's consider that the random model is when alpha is equal to 0, because then there is a constant probability to reveal links: f(n) = b.
Let's consider this definition of random model with our model.

```{r, message=FALSE}
library(data.table)
library(dplyr)
library(ggplot2)
require(magrittr)
library(tidyr)
library(igraph)
set.seed(1510)
`%ni%` <- Negate(`%in%`)
```


### Define variables

```{r}
plots_dir = "/home/j.aguirreplans/Projects/Scipher/SampleSize/data/out/plots"
tables_dir = "/home/j.aguirreplans/Projects/Scipher/SampleSize/data/out/tables"

dataset_selected = "gtex:whole.blood"
model_selected = "Stretched exponential (by linear fit)"
N_vals = seq(10, 50000, 10)

# Define palette using the scale_fill_brewer Oranges palette and selecting manually the colors using RColorBrewer
# https://stackoverflow.com/questions/29466239/how-to-set-the-color-range-of-scale-colour-brewer-in-ggplot2-palette-selecte 
blue_palette = RColorBrewer::brewer.pal(n = 9, "Blues") # I get 8 and exclude the 4 first
name2color <- c(
  "1.25" = blue_palette[2],
  "1.5" = blue_palette[3],
  "1.65" = blue_palette[5],
  "1.75" = blue_palette[7],
  "2" = blue_palette[9]
)
```

Read files:

```{r}
analytical_summary_file = paste(input_dir, 'analytical_model_summary_pearson_pval_0.05.txt', sep='/')
analytical_model_summary_df = fread(analytical_summary_file)
analytical_model_selected = analytical_model_summary_df %>% 
  dplyr::select(type_dataset, model, a, b, L, max_value_in_dataset, unnorm_L) %>% 
  filter((type_dataset == dataset_selected) & (model == model_selected)) %>% unique()
analytical_model_selected
```

### Run Test

```{r}
#'  calculate_predictions_using_stretched_exponential_model_optimized
#'  Formula to calculate exponential decay of significant interactions from a list of sample sizes.
#'  This formula requires the use of the L parameter
#'  @param x List of sample sizes.
#'  @param a Slope coefficient.
#'  @param b Intercept coefficient.
#'  
calculate_predictions_using_stretched_exponential_model_optimized = function(x, L, a, b){
  y = L * exp((b*x**(-a+1))/(-a+1))
  #y = exp(log(L) - exp(b+a*log(x)))
  return(y)
}

#'  calculate_prediction_from_analytical_model
#'  Function to calculate predictions using a specific analytical model
#'  @param model Name of the model used.
#'  @param x_list List of values in the x axis (e.g. size)
#'  @param a Parameter a.
#'  @param b Parameter b.
#'  @param L Parameter L.
#'  
calculate_prediction_from_analytical_model = function(model, x_list, a, b, L){
  if(model == "Logarithmic"){
    prediction_result = (log(x_list)*a + b)
  } else if(model == "Linear"){
    prediction_result = (x_list*a + b)
  } else if(model == "Exponential"){
    prediction_result = (exp((x_list*a + b)))
  } else if(model == "Square root"){
    prediction_result = (exp((log(x_list)*a + b)))
  } else if((model == "Stretched exponential (by optimization)") | (model == "Stretched exponential (by linear fit)")){
    prediction_result = calculate_predictions_using_stretched_exponential_model_optimized(x=x_list, L=L, a=a, b=b)
  } else if(model == "Stretched exponential (without L)"){
    prediction_result = calculate_predictions_using_stretched_exponential_model_without_L(x=x_list, a=a, b=b)
  }
  return(prediction_result)
}
```

For different alphas and sample sizes, calculate the predictions of the analytical model:

```{r}
list_alphas = c(round(analytical_model_selected$a, 2), 1, 2)
cols = c("model", "model_result", "size", "a", "L", "max_value_in_dataset")
predicted_results_df = data.frame(matrix(ncol=length(cols),nrow=0, dimnames=list(NULL, cols)))
for (alpha_selected in list_alphas){
  prediction_result = calculate_prediction_from_analytical_model(model=model_selected, x_list=N_vals, a=alpha_selected, b=analytical_model_selected$b, L=analytical_model_selected$L)
  prediction_result = prediction_result * analytical_model_selected$max_value_in_dataset
  predicted_results_df = rbind(predicted_results_df, data.frame(model=model_selected, model_result=prediction_result, size=N_vals, a=alpha_selected, L=analytical_model_selected$L, max_value_in_dataset=analytical_model_selected$max_value_in_dataset))
}

predicted_results_df_file = paste(tables_dir, 
                                "/comparison_alpha_zero_",
                                dataset_selected,
                                ".txt",
                                sep = "")

predicted_results_df %>% 
  fwrite(predicted_results_df_file)

head(predicted_results_df)
```

Plot the results comparing the analytical model with different alphas:

```{r}
N_vals = seq(10, 1000, 10)

predicted_results_df = predicted_results_df %>%
  filter(size %in% N_vals) %>%
  group_by(a) %>% mutate(norm = (model_result / max_value_in_dataset)/L) %>% ungroup() %>%
  mutate(a = factor(a, levels = as.character(sort(unique(predicted_results_df$a)))))

comparison_alphas_plot = predicted_results_df %>%
  ggplot(aes(x=log10(size), y=norm, col=a)) +
  geom_line(size=1) +
  scale_color_manual(name = expression(alpha), 
                     values = as.vector(name2color[levels(factor(predicted_results_df$a))])) +
  theme_linedraw() +
  xlab("Num. samples (Log10)") +
  ylab("Num. significant correlations") +
  theme(aspect.ratio = 1, 
        plot.title =  element_text(size = 20, face="bold"), 
        axis.title = element_text(size = 17, face="bold"), 
        axis.text = element_text(size = 16), 
        legend.text = element_text(size = 16), 
        legend.title=element_text(size=16, face="bold"),
        panel.grid.major=element_blank(), 
        panel.grid.minor = element_blank(),
        text = element_text(family = "Helvetica")
        )

plot_file = paste(plots_dir,
                  "/comparison_alpha_zero_",
                  dataset_selected,
                  ".png",
                  sep = "")
ggsave(
  plot_file,
  plot = comparison_alphas_plot,
  dpi = 1200,
  #width = 10000,
  height = 6000,
  units = c("px")
)
print(comparison_alphas_plot)
```