---
title: "Analyze differentially co-expressed genes"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Description

Analyze differentially co-expressed genes.

Based on this tutorial:
[https://deisygysi.github.io/teaching/minipeb2021/](https://deisygysi.github.io/teaching/minipeb2021/)

```{r, message=FALSE}
packrat::init("/home/j.aguirreplans/Projects/Scipher/SampleSize/scripts/SampleSizeR")
```

```{r}
library(data.table)
library(dplyr)
library(igraph)
library(ggalluvial)
library(ggplot2)
require(magrittr)
library(patchwork)
library(tidyr)
set.seed(1510)
library(NetSci)
options(bitmapType='cairo')
`%ni%` <- Negate(`%in%`)
```

### Load data

```{r}
name_D = "tcga.brca.female"
name_N = "tcga.breast.female"
disease_gene_associations_file = "/home/j.aguirreplans/Projects/Scipher/SampleSize/data/disease_genes/disease_genes_info_2022.csv"
disease_name_in_associations_file = "breast.neoplasms"
ppi_file = "/work/ccnr/j.aguirreplans/data/PPI/PPI_2022_04042022.csv"
plots_dir = "/home/j.aguirreplans/Projects/Scipher/SampleSize/data/out/plots/plots_differential_coexpression/TCGA-BRCA_female___TCGA-Breast_female"
tables_dir = "/home/j.aguirreplans/Projects/Scipher/SampleSize/data/out/tables/tables_differential_coexpression/TCGA-BRCA_female___TCGA-Breast_female"
name2color = data.frame(name=c("common", "disease-gene", "disease-specific", "normal-specific", "undefined", "different", "all"), color.codes=c("#619CFF", "#cc68f7", "#F8766D", "#00BA38", "#808080", "#C77CFF", "#CD9600"))
```


### Plot number of disease genes for category and size

Read file:

```{r}
counts_categories_file = paste(tables_dir, paste("codina_", name_D, "_", name_N, "_category_counts.txt", sep=""), sep="/")
counts_categories_df = fread(counts_categories_file)
```

Make plot:

```{r}
# Get colors
counts_categories_col_df = counts_categories_df %>%
  left_join(name2color, by=c("Phi_name"="name"))
reps = sort(unique(paste(counts_categories_df$rep_D, counts_categories_df$rep_N, sep="-")))

if(!(length(reps) == 1 && reps == "consensus-consensus")){
  plot_counts_categories = counts_categories_col_df %>% 
    group_by(Phi_name, size) %>%
    summarize(mean_disease = mean(n_disease), sd_disease = sd(n_disease), max_disease=max(n_disease), min_disease=min(n_disease)) %>%
    ggplot(aes(x = size, y = mean_disease, fill = Phi_name)) + 
    geom_line(aes(col = Phi_name)) +
    geom_ribbon(aes(ymin=min_disease, ymax=max_disease), alpha=0.2) +
    xlab("Number of samples") +
    ylab("Number of disease genes") +
    scale_fill_manual(values=setNames(counts_categories_col_df$color.codes, counts_categories_col_df$Phi_name)) +
    scale_color_manual(values=setNames(counts_categories_col_df$color.codes, counts_categories_col_df$Phi_name)) +
    guides(col=guide_legend(title="Gene category"), fill=guide_legend(title="Gene category")) +
    theme_linedraw() +
    theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title=element_text(size=14, face="bold"))
} else {
  plot_counts_categories = counts_categories_col_df %>% 
    group_by(Phi_name, size) %>%
    summarize(mean_disease = mean(n_disease)) %>%
    ggplot(aes(x = size, y = mean_disease)) + 
    geom_line(aes(col = Phi_name)) +
    xlab("Number of samples") +
    ylab("Number of disease genes") +
    scale_color_manual(values=setNames(counts_categories_col_df$color.codes, counts_categories_col_df$Phi_name)) +
    guides(col=guide_legend(title="Gene category"), fill=guide_legend(title="Gene category")) +
    theme_linedraw() +
    theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title=element_text(size=14, face="bold"))
}
plot_counts_categories
```

### Plot flow between gene categories across sample size

Read file:

```{r}
nodes_filtered_file = paste(tables_dir, paste("codina_", name_D, "_", name_N, "_nodes_filtered.txt", sep=""), sep="/")
nodes_filtered_df = fread(nodes_filtered_file)
```

Make plot:

```{r}
sizes_list = sort(unique(nodes_filtered_df$size))
if (max(sizes_list) <= 160) {
  sizes_to_plot = c(20, 40, 60, 80, 100, 120, 140, 160)
} else if ((max(sizes_list) > 160) & (max(sizes_list) <= 300)) {
  sizes_to_plot = c(20, 60, 100, 140, 180, 220, 260, 300)
} else if ((max(sizes_list) > 300) & (max(sizes_list) <= 440)) {
  sizes_to_plot = c(20, 80, 140, 200, 260, 320, 380, 440)
} else {
  sizes_to_plot = seq(20, max(sizes_list), 100)
}

nodes_filtered_df$Phi_name <- as.factor(nodes_filtered_df$Phi_name)
nodes_filtered_df$size = as.character(nodes_filtered_df$size)
levels(nodes_filtered_df$Phi_name) = sort(unique(nodes_filtered_df$Phi_name))
nodes_filtered_df$size <- factor(nodes_filtered_df$size, levels=as.character(sort(unique(as.integer(nodes_filtered_df$size)))))

# Get colors
nodes_filtered_col_df = nodes_filtered_df %>%
  left_join(name2color, by=c("Phi_name"="name"))

# Plot
plot_flow = nodes_filtered_col_df %>% 
  filter(size %in% sizes_to_plot) %>%
  filter(!(is.na(DiseaseName.no.sp.char))) %>%
  ggplot(aes(x = size, stratum = Phi_name, alluvium = Node, 
             fill = Phi_name, label = Phi_name)) +
  scale_fill_manual(values=setNames(nodes_filtered_col_df$color.codes, nodes_filtered_col_df$Phi_name)) +
  scale_color_manual(values=setNames(nodes_filtered_col_df$color.codes, nodes_filtered_col_df$Phi_name)) +
  geom_flow(stat = "alluvium", lode.guidance = "frontback") +
  geom_stratum() +
  xlab("Number of samples") +
  ylab("Number of disease genes") +
  guides(fill=guide_legend(title="Gene category")) +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), 
        axis.title = element_text(size = 14, face="bold"), 
        axis.text = element_text(size = 12), 
        #legend.position = "bottom",
        legend.text = element_text(size = 12), 
        legend.title=element_text(size=14, face="bold"))
plot_flow
```

### Plot stability in gene categories

Read file:

```{r}
change_of_category_file = paste(tables_dir, paste("codina_", name_D, "_", name_N, "_changes.txt", sep=""), sep="/")
change_of_category_df = fread(change_of_category_file)
```

Calculate stable genes by category:

```{r}
# Calculate total of stable genes
total_stable_change_genes_df = change_of_category_df %>%
  group_by(size.prev) %>% 
  mutate(n_total = n()) %>%
  ungroup() %>%
  select(Node, Phi_name.prev, size.prev, transition_type, n_total) %>% 
  group_by(size.prev, transition_type, n_total) %>% 
  summarize(n_genes = n()) %>% 
  ungroup() %>%
  mutate(frac_genes = n_genes / n_total)
total_stable_change_genes_df$Phi_name.prev = "all"

# Calculate stable genes by category
categories_stable_change_genes_df = change_of_category_df %>%
  group_by(size.prev) %>% 
  mutate(n_total = n()) %>%
  ungroup() %>%
  filter(transition_type == "stable") %>%
  select(Node, Phi_name.prev, size.prev, transition_type, n_total) %>% 
  group_by(Phi_name.prev, size.prev, transition_type, n_total) %>% 
  summarize(n_genes = n()) %>% 
  ungroup() %>%
  mutate(frac_genes = n_genes / n_total)
```

Make plot:

```{r}
stable_genes_df = rbind(total_stable_change_genes_df, categories_stable_change_genes_df) %>%
  filter(transition_type == "stable") %>%
  left_join(name2color, by=c("Phi_name.prev"="name"))
plot_stable_genes = stable_genes_df %>%
  ggplot(aes(x = size.prev, y = frac_genes, col = Phi_name.prev)) + 
  geom_line(aes(size = Phi_name.prev)) +
  xlab("Number of samples") +
  ylab("Fraction of stable genes") +
  scale_size_manual(values = c("all" = 1, "common" = 0.5, "disease-specific" = 0.5, "normal-specific" = 0.5, "undefined" = 0.5, "different" = 0.5)) +
  scale_color_manual(values=setNames(stable_genes_df$color.codes, stable_genes_df$Phi_name.prev)) +
  guides(col=guide_legend(title="Gene category"), size="none") +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title=element_text(size=14, face="bold"))
plot_stable_genes
```

### Analyze the modules of different categories considering all the genes

Read file:

```{r}
codina_ppi_analysis_file = paste(tables_dir, "codina_ppi_analysis.txt", sep="/")
codina_ppi_analysis_df = fread(codina_ppi_analysis_file)
head(codina_ppi_analysis_df)
```

Analyze number of nodes in the LCC:

```{r}
codina_ppi_analysis_df %>%
  filter(type_genes == "all") %>%
  ggplot(aes(x = size, y = num_nodes_lcc)) + 
  geom_line(aes(col = Phi_name)) +
  xlab("Number of samples") +
  ylab("Number of LCC nodes") +
  scale_color_manual(values=as.vector(name2color[name2color$name %in% levels(factor(unique(codina_ppi_analysis_df$Phi_name))),]$color.codes)) +
  guides(col=guide_legend(title="Gene category"), size="none") +
  theme_linedraw() +
  theme(aspect.ratio=1,
        plot.title =  element_text(size = 15, face="bold"),
        axis.title = element_text(size = 14, face="bold"),
        axis.text = element_text(size = 13),
        legend.text = element_text(size = 13),
        legend.title=element_text(size=14, face="bold"))
```

### Analyze the functional enrichment of different categories considering all the genes

Read files:

```{r}
enrichment_dir = paste(tables_dir, "functions_by_type_and_category_and_size", sep="/")
enrichment_files = list.files(enrichment_dir)
cols = c("size", "type_genes", "Phi_name", "GO.ID", "Term", "Annotated", "Significant", "Expected", "Rank in classic", "classic", "KS", "weight")
codina_ppi_go_enrichment_df = data.frame(matrix(ncol=length(cols),nrow=0, dimnames=list(NULL, cols)))
for(file_name in enrichment_files){
  info_file = gsub(".txt","",file_name)
  file_split1 = strsplit(info_file, split="_")[[1]]
  type_genes_selected = file_split1[(length(file_split1)-4)]
  category_selected = file_split1[(length(file_split1)-2)]
  size_selected = as.numeric(file_split1[length(file_split1)])
  enrichment_file = paste(enrichment_dir, file_name, sep="/")
  enrichment_single_df = fread(enrichment_file)
  if (nrow(enrichment_single_df) > 0){
    codina_ppi_go_enrichment_df = rbind(codina_ppi_go_enrichment_df, cbind(data.frame(size=size_selected, type_genes=type_genes_selected, Phi_name=category_selected), enrichment_single_df))
  }
}
```

Analyze number of functions enriched:

```{r}
codina_ppi_go_enrichment_df %>%
  filter(type_genes == "all") %>%
  group_by(Phi_name, size) %>% count() %>% ungroup() %>% arrange(size) %>%
  ggplot(aes(x = size, y = n)) + 
  geom_line(aes(col = Phi_name)) +
  xlab("Number of samples") +
  ylab("Number of enriched GO terms") +
  scale_color_manual(values=as.vector(name2color[name2color$name %in% levels(factor(unique(codina_ppi_go_enrichment_df$Phi_name))),]$color.codes)) +
  guides(col=guide_legend(title="Gene category"), size="none") +
  theme_linedraw() +
  theme(aspect.ratio=1,
        plot.title =  element_text(size = 15, face="bold"),
        axis.title = element_text(size = 14, face="bold"),
        axis.text = element_text(size = 13),
        legend.text = element_text(size = 13),
        legend.title=element_text(size=14, face="bold"))

```



