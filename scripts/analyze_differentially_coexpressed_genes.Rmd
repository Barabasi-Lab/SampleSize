---
title: "Analyze differentially co-expressed genes"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Description

Analyze differentially co-expressed genes.

Based on this tutorial:
[https://deisygysi.github.io/teaching/minipeb2021/](https://deisygysi.github.io/teaching/minipeb2021/)

```{r, message=FALSE}
library(data.table)
library(dplyr)
library(igraph)
library(ggalluvial)
library(ggplot2)
require(magrittr)
library(tidyr)
set.seed(1510)
options(bitmapType='cairo')
`%ni%` <- Negate(`%in%`)
```

### Load data

```{r}
plots_dir = "/home/j.aguirreplans/Projects/Scipher/SampleSize/data/out/plots"
```

### Prepare disease genes information dataset

Prepare the disease-gene associations: 

```{r}
disease_genes_info_file = "/home/j.aguirreplans/Projects/Scipher/SampleSize/data/disease_genes/disease_genes_info_2022.csv"

if(!(file.exists(disease_genes_info_file))){
  gene_associations_dir = '/work/ccnr/j.aguirreplans/data/gene_associations/data/out'
  disease_genes_file = paste(gene_associations_dir, 'GDA_Filtered_04042022.csv', sep='/')
  GDA = fread(disease_genes_file) %>% unique()
  GDA$HGNC_Symbol = toupper(GDA$HGNC_Symbol)
  GDA[is.na(GDA)]<-0
  GDA$NewName = tolower(GDA$NewName)
  GDA$DescriptorName = tolower(GDA$DescriptorName)
  GDA$MESHID = toupper(GDA$MESHID)
  GDA$HGNC_Symbol = toupper(GDA$HGNC_Symbol)
  GDA %<>% 
    filter(Strong > 0 | 
             Weak > 0 |
             Incompatible > 0) %>%
    mutate(DiseaseName = NewName) %>%
    filter(DescriptorName %ni% c("behavioral disciplines and activities")) %>%
    mutate(MESHID_remove = stringr::str_detect(TreeNumber, pattern = "C22|C25|F04")) %>%
    mutate(MESHID_remove = ifelse(TreeNumber == "F01", TRUE,MESHID_remove)) %>%
    filter(!(MESHID_remove)) %>%
    select(DiseaseName, HGNC_Symbol, DescriptorName) %>% 
    unique()
  
  # Make columns without special characters  
  GDA$DiseaseName.no.sp.char <- gsub(' ', '.', gsub(', ', '.', gsub('-', '.', gsub('[\\(\\)]', '', GDA$DiseaseName))))
  GDA$DescriptorName.no.sp.char <- gsub(' ', '.', gsub(', ', '.', gsub('-', '.', gsub('[\\(\\)]', '', GDA$DescriptorName))))
  
  # Write output file
  GDA %>% fwrite(disease_genes_info_file)
} else {
  GDA = fread(disease_genes_info_file)
}

head(GDA)
```

There are `r nrow(GDA)` disease-gene associations (`r length(unique(GDA$DiseaseName))` diseases, `r length(unique(GDA$HGNC_Symbol))` genes).


### Analyze breast carcinoma

Filter disease-gene associations by the disease "breast neoplasms":

```{r}
disease_name = "breast.neoplasms"
GDA_breast = GDA %>% select("DiseaseName.no.sp.char", "HGNC_Symbol") %>% filter(DiseaseName.no.sp.char == disease_name)
dim(GDA_breast)
head(GDA_breast)
```

Compile the files of the differential co-expression analysis from CODINA:

```{r}
input_dir = "/work/ccnr/j.aguirreplans/Scipher/SampleSize/differential_coexpression_analysis/TCGA-BRCA_Breast.Mammary.Tissue"
result_files = list.files(input_dir)

cols = c("file_name", "size", "rep_D", "rep_N")
file_info_df = data.frame(matrix(ncol=length(cols),nrow=0, dimnames=list(NULL, cols)))

for(file_name in result_files){
  info_file = gsub(".txt","",file_name)
  file_split1 = strsplit(info_file, split="_")[[1]]
  if(file_split1[1] == "diffanalysis"){
    type_analysis = file_split1[2]
    if(type_analysis == "nodes"){
      pval = tail(file_split1, n=1)
      info_file = gsub(paste("diffanalysis_", type_analysis, "_", sep=""),"",info_file)
      info_file = gsub(paste("_pval_", pval, sep=""),"",info_file)
      file_split2 = strsplit(info_file, split="___")[[1]]
      file_D_split = strsplit(gsub(".net","",file_split2[1]), split="_")[[1]]
      file_N_split = strsplit(gsub(".net","",file_split2[2]), split="_")[[1]]
      method = file_D_split[1]
      size = as.numeric(file_D_split[(length(file_D_split)-2)])
      r_D = as.numeric(file_D_split[(length(file_D_split))])
      r_N = as.numeric(file_N_split[(length(file_N_split))])
      dataset_D = file_D_split[(length(file_D_split)-4)]
      dataset_N = file_N_split[(length(file_N_split)-4)]
      file_info_df <- rbind(file_info_df, data.frame(file_name=file_name, size=size, rep_D=r_D, rep_N=r_N))
    }
  }
}

head(file_info_df)
```

Analyze differential co-expression analysis files, first counting genes per category and then analyzing if change across sample size:

```{r}
############################################
## count_differentially_coexpressed_nodes ##
############################################
#'  @param node_results_df Node results table from the differentially co-expression analysis of CODINA.
#'  @param disease_genes_df Table of genes associated to a specific disease.
#'  @param type_pval_correction Type of p-value correction for multiple testing. It can be "fdr", "bonferroni" or NA.
#'  @param pval_threshold P-value threshold to filter the differentially co-expressed nodes.

count_differentially_coexpressed_nodes <- function(node_results_df, disease_genes_df, type_pval_correction="fdr", pval_threshold=0.05){
  
  # Check type of p-value correction
  if(type_pval_correction == "fdr"){
    pval_correction_field = "pval_Phi_Tilde.adj.fdr"
  } else if(type_pval_correction == "bonferroni"){
    pval_correction_field = "pval_Phi_Tilde.adj.bonf"
  } else if(is.na(type_pval_correction)){
    pval_correction_field = "pval_Phi"
  } else {
    stop(paste("Unrecognized type of p-value correction: ", type_pval_correction, sep=""))
  }
  
  # Filter by p-value and join the disease-gene associations
  node_results_filt_df = node_results_df %>% select(Node, Phi_tilde, !!as.symbol(pval_correction_field)) %>% unique() %>% filter(!!as.symbol(pval_correction_field) < pval_threshold) %>% left_join(disease_genes_df, by=c("Node"="HGNC_Symbol"))
  # Count number of nodes in each category
  counts_df = node_results_filt_df %>% 
    group_by(Phi_tilde) %>%
    count() %>% 
    ungroup()
  # Count number of nodes that are disease-gene associations in each category
  counts_disease_df = node_results_filt_df %>% 
    filter(!(is.na(DiseaseName.no.sp.char))) %>%
    group_by(Phi_tilde) %>%
    count() %>% 
    ungroup() %>%
    rename("n_disease"="n")
  # Merge results
  counts_df = counts_df %>% full_join(counts_disease_df, by="Phi_tilde") %>% replace_na(list(n = 0, n_disease = 0))

  return(list(counts_df=counts_df, node_results_filt_df=node_results_filt_df))
}  
```

```{r}
type_pval_correction = "fdr"
pval_threshold = 0.05
sizes_list = sort(unique(file_info_df$size))
cols = c("Phi_tilde", "n", "n_disease", "size", "rep_D", "rep_N")
counts_nodes_df = data.frame(matrix(ncol=length(cols),nrow=0, dimnames=list(NULL, cols)))
cols = c("Node", "DiseaseName.no.sp.char", "Phi_tilde", "size", "rep_D", "rep_N")
nodes_df = data.frame(matrix(ncol=length(cols),nrow=0, dimnames=list(NULL, cols)))

for(x in seq(sizes_list)){
  size = sizes_list[x]
  #print(size)
  same_size_files_df = file_info_df %>% filter(size==!!size) %>% arrange(rep_D, rep_N)
  input_files = same_size_files_df$file_name
  # same_size_info_df = data.frame()
  for(input_file in input_files){
    r_D = (same_size_files_df %>% filter(file_name == input_file))$rep_D
    r_N = (same_size_files_df %>% filter(file_name == input_file))$rep_N
    individual_df = fread(paste(input_dir, input_file, sep="/"))
    results_count = count_differentially_coexpressed_nodes(individual_df, GDA_breast, type_pval_correction=type_pval_correction, pval_threshold=pval_threshold)
    counts_nodes_df = rbind(counts_nodes_df, cbind(results_count$counts_df, data.frame(size=size, rep_D=r_D, rep_N=r_N)))
    if(nrow(nodes_df) == 0){
      nodes_df = cbind((results_count$node_results_filt_df %>% select("Node", "DiseaseName.no.sp.char", "Phi_tilde")), data.frame(size=size, rep_D=r_D, rep_N=r_N))
    } else {
      nodes_df = nodes_df %>% full_join(cbind((results_count$node_results_filt_df %>% select("Node", "DiseaseName.no.sp.char", "Phi_tilde")), data.frame(size=size, rep_D=r_D, rep_N=r_N)), by=c("Node", "DiseaseName.no.sp.char", "Phi_tilde", "size", "rep_D", "rep_N"))
    }
  }
}

head(counts_nodes_df)
head(nodes_df)
```

We plot the number of genes in each category:

```{r}
plot_file = paste(plots_dir, "codina_tcga_brca_gtex_breast_counts_all_genes.png", sep="/")
counts_nodes_df %>% 
  group_by(Phi_tilde, size) %>%
  summarize(mean = mean(n), sd = sd(n), max=max(n), min=min(n)) %>%
  ggplot(aes(x = size, y = mean, fill = Phi_tilde)) + 
  geom_line(aes(col = Phi_tilde)) +
  geom_ribbon(aes(ymin=min, ymax=max), alpha=0.2) +
  xlab("Number of samples") +
  ylab("Number of genes") +
  guides(col=guide_legend(title="Gene category"), fill=guide_legend(title="Gene category")) +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title=element_text(size=14, face="bold"))
ggsave(plot_file, type='cairo', dpi = 300, height=7, width = 10)

plot_file = paste(plots_dir, "codina_tcga_brca_gtex_breast_counts_all_genes_log.png", sep="/")
counts_nodes_df %>% 
  group_by(Phi_tilde, size) %>%
  summarize(mean = mean(n), sd = sd(n), max=max(n), min=min(n)) %>%
  ggplot(aes(x = size, y = mean, fill = Phi_tilde)) + 
  geom_line(aes(col = Phi_tilde)) +
  geom_ribbon(aes(ymin=min, ymax=max), alpha=0.2) +
  scale_x_continuous(trans = scales::log10_trans()) +
  xlab("Number of samples (Log)") +
  ylab("Number of genes") +
  guides(col=guide_legend(title="Gene category"), fill=guide_legend(title="Gene category")) +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title=element_text(size=14, face="bold"))
ggsave(plot_file, type='cairo', dpi = 300, height=7, width = 10)
```

We plot specifically the number of breast neoplasms genes in each category:

```{r}
plot_file = paste(plots_dir, "codina_tcga_brca_gtex_breast_counts_disease_genes.png", sep="/")
counts_nodes_df %>% 
  group_by(Phi_tilde, size) %>%
  summarize(mean_disease = mean(n_disease), sd_disease = sd(n_disease), max_disease=max(n_disease), min_disease=min(n_disease)) %>%
  ggplot(aes(x = size, y = mean_disease, fill = Phi_tilde)) + 
  geom_line(aes(col = Phi_tilde)) +
  geom_ribbon(aes(ymin=min_disease, ymax=max_disease), alpha=0.2) +
  xlab("Number of samples") +
  ylab("Number of disease genes") +
  guides(col=guide_legend(title="Gene category"), fill=guide_legend(title="Gene category")) +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title=element_text(size=14, face="bold"))
ggsave(plot_file, type='cairo', dpi = 300, height=7, width = 10)

plot_file = paste(plots_dir, "codina_tcga_brca_gtex_breast_counts_disease_genes_log.png", sep="/")
counts_nodes_df %>% 
  group_by(Phi_tilde, size) %>%
  summarize(mean_disease = mean(n_disease), sd_disease = sd(n_disease), max_disease=max(n_disease), min_disease=min(n_disease)) %>%
  ggplot(aes(x = size, y = mean_disease, fill = Phi_tilde)) + 
  geom_line(aes(col = Phi_tilde)) +
  geom_ribbon(aes(ymin=min_disease, ymax=max_disease), alpha=0.2) +
  scale_x_continuous(trans = scales::log10_trans()) +
  xlab("Number of samples (Log)") +
  ylab("Number of disease genes") +
  guides(col=guide_legend(title="Gene category"), fill=guide_legend(title="Gene category")) +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title=element_text(size=14, face="bold"))
ggsave(plot_file, type='cairo', dpi = 300, height=7, width = 10)
```

We analyze the change of categories in genes across sample size.
To achieve it, we introduce as NA the genes that were not found in different sample sizes or repetitions:

```{r}
nodes_empty_df = expand.grid(sort(unique(nodes_df$Node)),sort(unique(nodes_df$size)), seq(1,5,1))
colnames(nodes_empty_df) = c("Node", "size", "rep_D")
nodes_empty_df$rep_N = nodes_empty_df$rep_D
nodes_empty_df = nodes_empty_df %>% left_join((nodes_df %>% select(Node, DiseaseName.no.sp.char) %>% unique()), by="Node") %>% arrange(Node, size, rep_D)
nodes_expanded_df = nodes_df %>% full_join(nodes_empty_df, by = c("Node", "DiseaseName.no.sp.char", "size", "rep_D", "rep_N")) %>% arrange(Node, size, rep_D)
```

We select the gene category that appears more in the different repetitions of each sample size:

```{r}
# Select the for each gene the node type that occurs more times in the different repetitions
nodes_summary_df = nodes_expanded_df %>% 
  group_by(Node, DiseaseName.no.sp.char, Phi_tilde, size) %>% 
  summarize(n_phi = n()) %>% 
  ungroup() %>%
  group_by(Node, DiseaseName.no.sp.char, size) %>%
  filter(n_phi == max(n_phi)) %>% 
  arrange(Node, size) %>% 
  sample_n(1) # Choose randomly cases in which there is the same number of node types 
 
nodes_summary_df
```

We create the alluvium plot showing the flow between gene categories across sample size:

```{r}
nodes_summary_df$Phi_tilde[is.na(nodes_summary_df$Phi_tilde)] = "U"
nodes_summary_df$Phi_tilde <- as.factor(nodes_summary_df$Phi_tilde)
nodes_summary_df$size = as.character(nodes_summary_df$size)
levels(nodes_summary_df$Phi_tilde) = sort(unique(nodes_summary_df$Phi_tilde))
nodes_summary_df$size <- factor(nodes_summary_df$size, levels=as.character(sort(unique(as.integer(nodes_summary_df$size)))))

plot_file = paste(plots_dir, "codina_tcga_brca_gtex_breast_change_disease_genes.png", sep="/")
nodes_summary_df %>% 
  #filter(size %in% c(100, 200, 300, 400)) %>%
  filter(size %in% c(60, 120, 180, 240, 300, 360, 420)) %>%
  filter(!(is.na(DiseaseName.no.sp.char))) %>%
  #filter(!(is.na(Phi_tilde))) %>%
  ggplot(aes(x = size, stratum = Phi_tilde, alluvium = Node, 
             fill = Phi_tilde, label = Phi_tilde)) +
  scale_fill_brewer(type = "qual", palette = "Set2") +
  geom_flow(stat = "alluvium", lode.guidance = "frontback") +
  geom_stratum() +
  xlab("Number of samples") +
  ylab("Number of disease genes") +
  guides(fill=guide_legend(title="Gene category")) +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title=element_text(size=14, face="bold"), legend.position = "bottom")
ggsave(plot_file, type='cairo', dpi = 300, height=7, width = 10)
```

### Analyze rheumatoid arthritis

Filter disease-gene associations by the disease "arthritis rheumatoid":

```{r}
disease_name = "arthritis.rheumatoid"
GDA_ra = GDA %>% select("DiseaseName.no.sp.char", "HGNC_Symbol") %>% filter(DiseaseName.no.sp.char == disease_name)
dim(GDA_ra)
head(GDA_ra)
```

Compile the files of the differential co-expression analysis from CODINA:

```{r}
input_dir = "/work/ccnr/j.aguirreplans/Scipher/SampleSize/differential_coexpression_analysis/complete.dataset_Whole.Blood"
result_files = list.files(input_dir)

cols = c("file_name", "size", "rep_D", "rep_N")
file_info_df = data.frame(matrix(ncol=length(cols),nrow=0, dimnames=list(NULL, cols)))

for(file_name in result_files){
  info_file = gsub(".txt","",file_name)
  file_split1 = strsplit(info_file, split="_")[[1]]
  if(file_split1[1] == "diffanalysis"){
    type_analysis = file_split1[2]
    if(type_analysis == "nodes"){
      pval = tail(file_split1, n=1)
      info_file = gsub(paste("diffanalysis_", type_analysis, "_", sep=""),"",info_file)
      info_file = gsub(paste("_pval_", pval, sep=""),"",info_file)
      file_split2 = strsplit(info_file, split="___")[[1]]
      file_D_split = strsplit(gsub(".net","",file_split2[1]), split="_")[[1]]
      file_N_split = strsplit(gsub(".net","",file_split2[2]), split="_")[[1]]
      method = file_D_split[1]
      size = as.numeric(file_D_split[(length(file_D_split)-2)])
      r_D = as.numeric(file_D_split[(length(file_D_split))])
      r_N = as.numeric(file_N_split[(length(file_N_split))])
      dataset_D = file_D_split[(length(file_D_split)-4)]
      dataset_N = file_N_split[(length(file_N_split)-4)]
      file_info_df <- rbind(file_info_df, data.frame(file_name=file_name, size=size, rep_D=r_D, rep_N=r_N))
    }
  }
}

head(file_info_df)
```

Analyze differential co-expression analysis files, first counting genes per category and then analyzing if change across sample size:

```{r}
type_pval_correction = "fdr"
pval_threshold = 0.05
sizes_list = sort(unique(file_info_df$size))
cols = c("Phi_tilde", "n", "n_disease", "size", "rep_D", "rep_N")
counts_nodes_df = data.frame(matrix(ncol=length(cols),nrow=0, dimnames=list(NULL, cols)))
cols = c("Node", "DiseaseName.no.sp.char", "Phi_tilde", "size", "rep_D", "rep_N")
nodes_df = data.frame(matrix(ncol=length(cols),nrow=0, dimnames=list(NULL, cols)))

for(x in seq(sizes_list)){
  size = sizes_list[x]
  #print(size)
  same_size_files_df = file_info_df %>% filter(size==!!size) %>% arrange(rep_D, rep_N)
  input_files = same_size_files_df$file_name
  # same_size_info_df = data.frame()
  for(input_file in input_files){
    r_D = (same_size_files_df %>% filter(file_name == input_file))$rep_D
    r_N = (same_size_files_df %>% filter(file_name == input_file))$rep_N
    individual_df = fread(paste(input_dir, input_file, sep="/"))
    results_count = count_differentially_coexpressed_nodes(individual_df, GDA_ra, type_pval_correction=type_pval_correction, pval_threshold=pval_threshold)
    counts_nodes_df = rbind(counts_nodes_df, cbind(results_count$counts_df, data.frame(size=size, rep_D=r_D, rep_N=r_N)))
    if(nrow(nodes_df) == 0){
      nodes_df = cbind((results_count$node_results_filt_df %>% select("Node", "DiseaseName.no.sp.char", "Phi_tilde")), data.frame(size=size, rep_D=r_D, rep_N=r_N))
    } else {
      nodes_df = nodes_df %>% full_join(cbind((results_count$node_results_filt_df %>% select("Node", "DiseaseName.no.sp.char", "Phi_tilde")), data.frame(size=size, rep_D=r_D, rep_N=r_N)), by=c("Node", "DiseaseName.no.sp.char", "Phi_tilde", "size", "rep_D", "rep_N"))
    }
  }
}

head(counts_nodes_df)
head(nodes_df)
```

We plot the number of genes in each category:

```{r}
plot_file = paste(plots_dir, "codina_scipher_ra_gtex_wholeblood_counts_all_genes.png", sep="/")
counts_nodes_df %>% 
  group_by(Phi_tilde, size) %>%
  summarize(mean = mean(n), sd = sd(n), max=max(n), min=min(n)) %>%
  ggplot(aes(x = size, y = mean, fill = Phi_tilde)) + 
  geom_line(aes(col = Phi_tilde)) +
  geom_ribbon(aes(ymin=min, ymax=max), alpha=0.2) +
  xlab("Number of samples") +
  ylab("Number of genes") +
  guides(col=guide_legend(title="Gene category"), fill=guide_legend(title="Gene category")) +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title=element_text(size=14, face="bold"))
ggsave(plot_file, type='cairo', dpi = 300, height=7, width = 10)

plot_file = paste(plots_dir, "codina_scipher_ra_gtex_wholeblood_counts_all_genes_log.png", sep="/")
counts_nodes_df %>% 
  group_by(Phi_tilde, size) %>%
  summarize(mean = mean(n), sd = sd(n), max=max(n), min=min(n)) %>%
  ggplot(aes(x = size, y = mean, fill = Phi_tilde)) + 
  geom_line(aes(col = Phi_tilde)) +
  geom_ribbon(aes(ymin=min, ymax=max), alpha=0.2) +
  scale_x_continuous(trans = scales::log10_trans()) +
  xlab("Number of samples (Log)") +
  ylab("Number of genes") +
  guides(col=guide_legend(title="Gene category"), fill=guide_legend(title="Gene category")) +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title=element_text(size=14, face="bold"))
ggsave(plot_file, type='cairo', dpi = 300, height=7, width = 10)
```

We plot specifically the number of arthritis rheumatoid genes in each category:

```{r}
plot_file = paste(plots_dir, "codina_scipher_ra_gtex_wholeblood_counts_disease_genes.png", sep="/")
counts_nodes_df %>% 
  group_by(Phi_tilde, size) %>%
  summarize(mean_disease = mean(n_disease), sd_disease = sd(n_disease), max_disease=max(n_disease), min_disease=min(n_disease)) %>%
  ggplot(aes(x = size, y = mean_disease, fill = Phi_tilde)) + 
  geom_line(aes(col = Phi_tilde)) +
  geom_ribbon(aes(ymin=min_disease, ymax=max_disease), alpha=0.2) +
  xlab("Number of samples") +
  ylab("Number of disease genes") +
  guides(col=guide_legend(title="Gene category"), fill=guide_legend(title="Gene category")) +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title=element_text(size=14, face="bold"))
ggsave(plot_file, type='cairo', dpi = 300, height=7, width = 10)

plot_file = paste(plots_dir, "codina_scipher_ra_gtex_wholeblood_counts_disease_genes_log.png", sep="/")
counts_nodes_df %>% 
  group_by(Phi_tilde, size) %>%
  summarize(mean_disease = mean(n_disease), sd_disease = sd(n_disease), max_disease=max(n_disease), min_disease=min(n_disease)) %>%
  ggplot(aes(x = size, y = mean_disease, fill = Phi_tilde)) + 
  geom_line(aes(col = Phi_tilde)) +
  geom_ribbon(aes(ymin=min_disease, ymax=max_disease), alpha=0.2) +
  scale_x_continuous(trans = scales::log10_trans()) +
  xlab("Number of samples") +
  ylab("Number of disease genes") +
  guides(col=guide_legend(title="Gene category"), fill=guide_legend(title="Gene category")) +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title=element_text(size=14, face="bold"))
ggsave(plot_file, type='cairo', dpi = 300, height=7, width = 10)

```

We analyze the change of categories in genes across sample size.
To achieve it, we introduce as NA the genes that were not found in different sample sizes or repetitions:

```{r}
nodes_empty_df = expand.grid(sort(unique(nodes_df$Node)),sort(unique(nodes_df$size)), seq(1,5,1))
colnames(nodes_empty_df) = c("Node", "size", "rep_D")
nodes_empty_df$rep_N = nodes_empty_df$rep_D
nodes_empty_df = nodes_empty_df %>% left_join((nodes_df %>% select(Node, DiseaseName.no.sp.char) %>% unique()), by="Node") %>% arrange(Node, size, rep_D)
nodes_expanded_df = nodes_df %>% full_join(nodes_empty_df, by = c("Node", "DiseaseName.no.sp.char", "size", "rep_D", "rep_N")) %>% arrange(Node, size, rep_D)
```

We select the gene category that appears more in the different repetitions of each sample size:

```{r}
# Select the for each gene the node type that occurs more times in the different repetitions
nodes_summary_df = nodes_expanded_df %>% 
  group_by(Node, DiseaseName.no.sp.char, Phi_tilde, size) %>% 
  summarize(n_phi = n()) %>% 
  ungroup() %>%
  group_by(Node, DiseaseName.no.sp.char, size) %>%
  filter(n_phi == max(n_phi)) %>% 
  arrange(Node, size) %>% 
  sample_n(1) # Choose randomly cases in which there is the same number of node types 
 
nodes_summary_df
```

We create the alluvium plot showing the flow between gene categories across sample size:

```{r}
nodes_summary_df$Phi_tilde[is.na(nodes_summary_df$Phi_tilde)] = "U"
nodes_summary_df$Phi_tilde <- as.factor(nodes_summary_df$Phi_tilde)
nodes_summary_df$size = as.character(nodes_summary_df$size)
levels(nodes_summary_df$Phi_tilde) = sort(unique(nodes_summary_df$Phi_tilde))
nodes_summary_df$size <- factor(nodes_summary_df$size, levels=as.character(sort(unique(as.integer(nodes_summary_df$size)))))

plot_file = paste(plots_dir, "codina_scipher_ra_gtex_wholeblood_change_disease_genes.png", sep="/")
nodes_summary_df %>% 
  #filter(size %in% c(100, 200, 300, 400)) %>%
  filter(size %in% c(60, 120, 180, 240, 300, 360, 420)) %>%
  filter(!(is.na(DiseaseName.no.sp.char))) %>%
  #filter(!(is.na(Phi_tilde))) %>%
  ggplot(aes(x = size, stratum = Phi_tilde, alluvium = Node, 
             fill = Phi_tilde, label = Phi_tilde)) +
  scale_fill_brewer(type = "qual", palette = "Set2") +
  geom_flow(stat = "alluvium", lode.guidance = "frontback") +
  geom_stratum() +
  xlab("Number of samples") +
  ylab("Number of disease genes") +
  guides(fill=guide_legend(title="Gene category")) +
  theme_linedraw() +
  theme(plot.title =  element_text(size = 17, face="bold"), axis.title = element_text(size = 14, face="bold"), axis.text = element_text(size = 12), legend.text = element_text(size = 12), legend.title=element_text(size=14, face="bold"), legend.position = "bottom")
ggsave(plot_file, type='cairo', dpi = 300, height=7, width = 10)

```