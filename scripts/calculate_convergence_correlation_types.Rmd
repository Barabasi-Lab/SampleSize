---
title: "Calculation of convergence points of correlation types"
author: "Joaquim Aguirre-Plans"
date: "6/28/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Description

Calculate the sample size where a specific type of correlations converge. We will use two methods:
- Using the statistical formula
- Manually

```{r}
library(data.table)
library(dplyr)
library(igraph)
library(ggplot2)
require(magrittr)
set.seed(1510)
options(bitmapType='cairo')
`%ni%` <- Negate(`%in%`)
```

## Statistical formula

Read the number of edges of each dataset:

```{r}
input_dir = '/home/j.aguirreplans/Projects/Scipher/SampleSize/scripts/SampleSizeShiny/data'
numbers_file = paste(input_dir, 'dataset_numbers_complete_graph.txt', sep='/')
numbers_df = fread(numbers_file)
numbers_df$dataset = tolower(numbers_df$dataset)
print(numbers_df)
```

Define function to calculate sample size for correlation:

```{r}
calculate_sample_size_for_pearson_correlation = function(r, total_num_edges, alpha=0.05, power=0.8){
  alpha_corrected = alpha / total_num_edges # Correct alpha by multiple error
  Za = qnorm(alpha, lower.tail=F)
  Za_corrected = qnorm(alpha_corrected, lower.tail=F)
  Zb = qnorm(power, lower.tail=F)
  N = ((Za + Zb) / (0.5 * log((1+r)/(1-r))))**2 + 3
  N_corrected = ((Za_corrected + Zb) / (0.5 * log((1+r)/(1-r))))**2 + 3
  return(list(N=N, N_corrected=N_corrected))
}
```

Calculate sample size for different levels of correlation and different datasets:

```{r}
type_correlation_df = data.frame(type_correlation=c("weak", "moderate", "strong", "very strong"), lower_val=c(0.2,0.4,0.6,0.8), upper_val=c(0.4,0.6,0.8,NA))
types_correlation = c("weak", "moderate", "strong", "very strong")

cols = c("dataset", "type_correlation", "correlation", "sample_size", "sample_size_corrected")
sample_size_correlation_df = data.frame(matrix(ncol=length(cols),nrow=0, dimnames=list(NULL, cols)))
for (dataset in numbers_df$dataset){
  total_num_edges = (numbers_df %>% filter(dataset == !!dataset))$total_num_edges
  for (type_correlation in types_correlation){
    r = (type_correlation_df %>% filter(type_correlation == !!type_correlation))$lower_val
    N_result = calculate_sample_size_for_pearson_correlation(r=r, total_num_edges=total_num_edges, alpha=0.05, power=0.8)
    sample_size_correlation_df <- rbind(sample_size_correlation_df, data.frame(dataset=dataset, type_correlation=type_correlation, correlation=r, sample_size=N_result$N, sample_size_corrected=N_result$N_corrected))
  }
}

print(sample_size_correlation_df)
```

## Manual

Read the number of edges for each dataset:

```{r}
input_dir = '/home/j.aguirreplans/Projects/Scipher/SampleSize/scripts/SampleSizeShiny/data'
topology_results_file = paste(input_dir, 'analysis_topology.csv', sep='/')
topology_results_df = fread(topology_results_file)
topology_results_df$dataset = paste(topology_results_df$dataset, topology_results_df$type_dataset, sep=":") # Join dataset and type_dataset
topology_results_df$dataset = tolower(topology_results_df$dataset)
head(topology_results_df)
```

Calculate sample size where each type of correlation converges:

```{r}
type_correlation_df = data.frame(type_correlation=c("strong-very strong", "moderate-strong-very strong", "weak-moderate-strong-very strong"), lower_val=c(0.6,0.4,0.2), upper_val=c(NA,NA,NA))
types_correlation = c("strong-very strong", "moderate-strong-very strong", "weak-moderate-strong-very strong")
method = "pearson"
threshold = 0.05

cols = c("dataset", "type_correlation", "correlation", "sample_size_max_value", "sample_size_sliding")
size_convergence_correlation_df = data.frame(matrix(ncol=length(cols),nrow=0, dimnames=list(NULL, cols)))
for (dataset in numbers_df$dataset){
  for (type_correlation in types_correlation){
    r = (type_correlation_df %>% filter(type_correlation == !!type_correlation))$lower_val
    topology_results_selected_df = topology_results_df %>% filter((method == !!method) & (dataset == !!dataset) & (type_correlation == !!type_correlation) & (threshold == !!threshold)) %>% select(size, rep, num_edges)
    topology_results_selected_by_size_df = topology_results_selected_df %>%
      group_by(size) %>%
      summarise(mean=mean(num_edges), sd=sd(num_edges)) %>%
      arrange(size)
    max_value = max(topology_results_selected_by_size_df$mean)

    size_convergence_correlation_df <- rbind(size_convergence_correlation_df, data.frame(dataset=dataset, type_correlation=type_correlation, correlation=r, sample_size_max_value=max_value, sample_size_sliding=NA))
  }
}

print(size_convergence_correlation_df)
```
